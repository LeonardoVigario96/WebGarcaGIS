<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#667eea">
  <title>WebGIS DO MUNIC√çPIO DE GAR√áA-SP</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  
  <style>
    /* ===== RESET E CONFIGURA√á√ïES BASE ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8fafc;
      overflow-x: hidden;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    
    /* ===== HEADER ===== */
    #map-title-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      z-index: 2000;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    #logo-img {
      max-height: 42px;
      width: auto;
      margin-right: 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.25);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      padding: 6px;
      transition: all 0.3s ease;
      border: 2px solid rgba(255,255,255,0.3);
    }
    
    #logo-img:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      background: rgba(255,255,255,0.4);
      border-color: rgba(255,255,255,0.5);
    }
    
    /* ===== MAPA ===== */
    #map {
      height: calc(100vh - 60px);
      width: 100vw;
      margin-top: 60px;
      border-radius: 0;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1;
      position: relative;
    }
    
    /* ===== CONTROLES ===== */
    .control-btn {
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      color: #1976d2;
      border: none;
      border-radius: 20px;
      width: 44px;
      height: 36px;
      font-size: 1.08rem;
      cursor: pointer;
      box-shadow: 0 1px 4px rgba(0,0,0,0.10);
      z-index: 2100;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 400;
    }
    
    /* ===== CONTROLES DE ZOOM SOFISTICADOS ===== */
    #sophisticated-zoom-controls {
      position: absolute;
      top: 80px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
      border-radius: 12px;
      padding: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    #sophisticated-zoom-controls:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.92) 100%);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.3);
      transform: translateY(-1px) scale(1.005);
    }
    
    .zoom-control-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 1px 6px rgba(102, 126, 234, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.2);
    }
    
    .zoom-control-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .zoom-control-btn:hover::before {
      left: 100%;
    }
    
    .zoom-control-btn:hover {
      transform: scale(1.05) translateY(-1px);
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.3);
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }
    
    .zoom-control-btn:active {
      transform: scale(0.95) translateY(1px);
      box-shadow: 0 1px 6px rgba(102, 126, 234, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2);
    }
    
    .zoom-control-btn:disabled {
      background: linear-gradient(135deg, #ccc 0%, #999 100%);
      cursor: not-allowed;
      transform: none;
    }
    
    .zoom-control-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }
    
    .zoom-control-btn:disabled::before {
      display: none;
    }
    
    #zoom-level-display {
      width: 32px;
      height: 22px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: #374151;
      margin: 3px 0;
      position: relative;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(102, 126, 234, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.8);
      transition: all 0.3s ease;
    }
    
    #zoom-level-display::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(102, 126, 234, 0.1) 50%, transparent 70%);
      animation: shimmer 3s infinite;
    }
    
    #zoom-level-display.zoom-changed {
      animation: zoomPulse 0.5s ease-in-out;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    @keyframes zoomPulse {
      0% { 
        transform: scale(1);
        box-shadow: 0 1px 6px rgba(102, 126, 234, 0.15);
      }
      50% { 
        transform: scale(1.03);
        box-shadow: 0 2px 12px rgba(102, 126, 234, 0.3);
      }
      100% { 
        transform: scale(1);
        box-shadow: 0 1px 6px rgba(102, 126, 234, 0.15);
      }
    }
    
    .zoom-reset-btn {
      width: 32px;
      height: 24px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
      color: white;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 1px 6px rgba(255, 107, 107, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.2);
    }
    
    .zoom-reset-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }
    
    .zoom-reset-btn:hover::before {
      left: 100%;
    }
    
    .zoom-reset-btn:hover {
      transform: scale(1.05) translateY(-1px);
      box-shadow: 0 4px 16px rgba(255, 107, 107, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.3);
      background: linear-gradient(135deg, #ff5252 0%, #d32f2f 100%);
    }
    
    .zoom-reset-btn:active {
      transform: scale(0.95) translateY(1px);
      box-shadow: 0 1px 6px rgba(255, 107, 107, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.2);
    }
    
    .control-btn:hover {
      background: #bbdefb;
      transform: scale(1.05);
    }
    
    #about-btn {
      right: 18px;
      top: 8px;
    }
    
    #fullscreen-btn {
      right: 70px;
      top: 8px;
    }
    
    #measurement-toggle {
      right: 120px;
      top: 8px;
    }
    
    #layers-toggle {
      right: 170px;
      top: 8px;
    }
    
    #basemap-toggle {
      right: 220px;
      top: 8px;
    }

                        /* ===== GO TO PANEL ===== */
                    #goto-panel {
                      position: absolute;
                      bottom: 60px;
                      right: 80px;
                      display: flex;
                      flex-direction: column;
                      gap: 8px;
                      z-index: 1000;
                    }
                
                    .goto-btn {
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      padding: 10px 16px;
                      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
                      border: 1px solid rgba(255, 255, 255, 0.4);
                      border-radius: 12px;
                      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2);
                      backdrop-filter: blur(15px);
                      color: #374151;
                      font-size: 13px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                      min-width: 140px;
                    }

    .goto-btn:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.92) 100%);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.3);
      transform: translateY(-2px) scale(1.02);
      color: #1f2937;
    }

    .goto-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2);
    }

    .goto-btn i {
      font-size: 14px;
      width: 16px;
      text-align: center;
    }

                        .goto-btn span {
                      white-space: nowrap;
                    }
                
                    .goto-btn .goto-label {
                      font-size: 11px;
                      font-weight: 500;
                      color: #6b7280;
                      margin-right: 4px;
                    }

    /* Concha Ac√∫stica button specific styling */
    #goto-concha {
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%);
      border-color: rgba(147, 51, 234, 0.3);
    }

    #goto-concha:hover {
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.15) 0%, rgba(168, 85, 247, 0.1) 100%);
      border-color: rgba(147, 51, 234, 0.5);
      color: #7c3aed;
    }

    #goto-concha i {
      color: #8b5cf6;
    }

    /* Lago Artificial button specific styling */
    #goto-lago {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(96, 165, 250, 0.05) 100%);
      border-color: rgba(59, 130, 246, 0.3);
    }

    #goto-lago:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(96, 165, 250, 0.1) 100%);
      border-color: rgba(59, 130, 246, 0.5);
      color: #2563eb;
    }

    #goto-lago i {
      color: #3b82f6;
    }

                        /* Responsive Go to Panel */
                    @media (max-width: 768px) {
                      #goto-panel {
                        bottom: 50px;
                        right: 70px;
                        gap: 6px;
                      }
                
                      .goto-btn {
                        padding: 8px 12px;
                        font-size: 12px;
                        min-width: 110px;
                        border-radius: 10px;
                      }
                
                      .goto-btn i {
                        font-size: 12px;
                        width: 14px;
                      }
                
                      .goto-btn .goto-label {
                        font-size: 10px;
                      }
                    }

                        @media (max-width: 480px) {
                      #goto-panel {
                        bottom: 40px;
                        right: 60px;
                        gap: 5px;
                      }
                
                      .goto-btn {
                        padding: 6px 10px;
                        font-size: 11px;
                        min-width: 100px;
                        border-radius: 8px;
                      }
                
                      .goto-btn i {
                        font-size: 11px;
                        width: 12px;
                      }
                
                      .goto-btn .goto-label {
                        font-size: 9px;
                      }
                    }

    /* ===== PAINEL DE MEDI√á√ÉO ===== */
    #measurement-panel {
      position: absolute;
      top: 70px;
      right: 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      min-width: 180px;
      z-index: 1000;
      display: none;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .measurement-btn {
      display: block;
      width: 100%;
      padding: 12px 16px;
      background: none;
      border: none;
      text-align: left;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .measurement-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #1f2937;
    }

    .measurement-btn.active {
      background: rgba(59, 130, 246, 0.15);
      color: #1d4ed8;
      font-weight: 600;
    }

    .measurement-btn:last-child {
      border-bottom: none;
    }
    
    /* ===== MINI MAPA ===== */
    #mini-map-container {
      position: absolute;
      top: 80px;
      left: 20px;
      width: 180px;
      height: 140px;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1500;
      overflow: hidden;
      display: block;
      box-sizing: border-box;
    }
    
    #mini-map {
      width: 100%;
      height: 100%;
    }
    
    #mini-map-toggle {
      position: absolute;
      top: 60px;
      left: 20px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      z-index: 1501;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background 0.2s;
    }
    
    #mini-map-toggle:hover {
      background: #f0f0f0;
    }
    
    /* ===== LEGENDA ===== */
    .info.legend {
      position: absolute;
      bottom: 40px;
      left: 20px;
      top: auto;
      margin: 0;
      right: auto;
      background: #fff;
      transform: none;
      border-radius: 8px;
      transform-origin: top left;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      perspective: none;
      border: 2px solid #ccc;
      backface-visibility: visible;
      padding: 8px;
      opacity: 1;
      width: 180px;
      visibility: visible;
      box-sizing: border-box;
      clip: auto;
      font-size: 10px;
      clip-path: none;
      font-weight: normal;
      filter: none;
      line-height: 1.3;
      mix-blend-mode: normal;
      font-family: Arial, sans-serif;
      isolation: auto;
      z-index: 1500;
      contain: none;
      text-align: left;
      contain-layout: none;
      max-height: 400px;
      contain-paint: none;
      white-space: normal;
      contain-style: none;
      overflow: auto;
      contain-size: none;
      word-wrap: normal;
      contain-intrinsic-size: none;
      color: #333;
      contain-intrinsic-block-size: none;
      vertical-align: top;
      contain-intrinsic-inline-size: none;
      transition: background 0.2s;
      contain-intrinsic-width: none;
      float: none;
      contain-intrinsic-height: none;
      display: block;
      contain-intrinsic-min-width: none;
      clear: none;
      contain-intrinsic-max-width: none;
      contain-intrinsic-min-height: none;
      contain-intrinsic-max-height: none;
    }
    
    .info.legend:hover {
      background: #f0f0f0;
    }
    
    .info.legend h4 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 12px;
      font-weight: 600;
      border-bottom: 1px solid #ccc;
      padding-bottom: 8px;
    }
    

    
    .info.legend i {
      margin-right: 8px;
      width: 12px;
      height: 12px;
      border-radius: 2px;
      display: inline-block;
      vertical-align: middle;
      border: 1px solid #ccc;
    }
    
    .info.legend br {
      margin-bottom: 2px;
    }
    

    

    
    /* ===== CONTROLES DE OPACIDADE ===== */
    .opacity-control {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 12px;
      font-size: 13px;
      min-width: 140px;
      max-width: 200px;
      z-index: 1000;
    }
    
    .opacity-control label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .opacity-control input[type=range] {
      width: 100%;
      margin-bottom: 6px;
      accent-color: #667eea;
      height: 4px;
      border-radius: 2px;
    }
    
    .opacity-control strong {
      font-size: 13px;
      margin-bottom: 2px;
      display: block;
      font-weight: 600;
    }
    
    /* ===== COORDENADAS ===== */
    #coordinates-display {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 12px;
      font-family: monospace;
      min-width: 200px;
      text-align: left;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      color: #000;
      font-weight: bold;
      z-index: 1000;
      white-space: nowrap;
    }
    
    /* ===== MODAL ===== */
    #about-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.35);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 0;
      min-width: 380px;
      max-width: 90vw;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      position: relative;
      text-align: left;
      font-size: 1rem;
    }

    /* Header do modal */
    .about-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px 28px 20px 28px;
      border-radius: 16px 16px 0 0;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .author-avatar {
      width: 60px;
      height: 60px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.3);
    }

    .avatar-icon {
      font-size: 28px;
    }

    .author-info h2 {
      margin: 0 0 4px 0;
      font-size: 1.4rem;
      font-weight: 600;
      line-height: 1.2;
    }

    .author-title {
      margin: 0;
      font-size: 0.95rem;
      opacity: 0.9;
      font-weight: 400;
    }

    .author-subtitle {
      margin: 4px 0 0 0;
      font-size: 0.85rem;
      opacity: 0.8;
      font-weight: 400;
    }

    /* Conte√∫do principal */
    .about-content {
      padding: 28px;
    }

    /* Se√ß√µes */
    .contact-section,
    .project-section,
    .tech-section {
      margin-bottom: 24px;
    }

    .contact-section h3,
    .project-section h3,
    .tech-section h3 {
      margin: 0 0 16px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Grid de contatos */
    .contact-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      transition: all 0.2s ease;
    }

    .contact-item:hover {
      background: #e9ecef;
      transform: translateX(4px);
    }

    .contact-icon {
      font-size: 20px;
      min-width: 24px;
    }

    .contact-details {
      flex: 1;
    }

    .contact-details strong {
      display: block;
      font-size: 0.9rem;
      color: #495057;
      margin-bottom: 2px;
    }

    .contact-details a {
      color: #667eea;
      text-decoration: none;
      font-size: 0.9rem;
      transition: color 0.2s ease;
    }

    .contact-details a:hover {
      color: #5a6fd8;
      text-decoration: underline;
    }

    /* Se√ß√£o do projeto */
    .project-info p {
      margin: 0;
      line-height: 1.6;
      color: #495057;
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #28a745;
    }

    /* Grid de tecnologias */
    .tech-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tech-tag {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }

    /* Logo do projeto */
    .project-logo {
      text-align: center;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e9ecef;
    }

    .project-logo img {
      max-width: 160px;
      max-height: 120px;
      width: auto;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      background: white;
      padding: 8px;
    }

    .logo-caption {
      margin: 12px 0 0 0;
      font-size: 0.9rem;
      color: #6c757d;
      font-weight: 500;
    }

              /* Seta Norte */
          #north-arrow {
            position: absolute;
            bottom: 60px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            border: 2px solid #fff;
            cursor: pointer;
            transition: all 0.3s ease;
          }

              #north-arrow:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: scale(1.1);
          }

    #north-arrow svg {
      display: block;
    }
    
    #close-modal {
      position: absolute;
      top: 10px;
      right: 14px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #263238;
      cursor: pointer;
    }
    
    /* ===== RESPONSIVIDADE ===== */
    @media (max-width: 768px) {
      #map-title-bar {
        height: 50px;
        font-size: 1rem;
        padding: 0 16px;
        gap: 8px;
      }
      
      #logo-img {
        max-height: 32px;
        margin-right: 6px;
        padding: 4px;
        border-width: 1.5px;
      }
      
      #map {
        height: calc(100vh - 50px);
        margin-top: 50px;
      }
      
      .control-btn {
        width: 36px;
        height: 30px;
        font-size: 0.98rem;
      }
      
      #about-btn { right: 8px; top: 4px; }
      #fullscreen-btn { right: 50px; top: 4px; }
      #measurement-toggle { right: 92px; top: 4px; }
      #layers-toggle { right: 134px; top: 4px; }
      #basemap-toggle { right: 176px; top: 4px; }
      
      .info.legend {
        font-size: 10px;
        font-weight: 400;
        width: 140px;
        padding: 10px;
        box-sizing: border-box;
        border-radius: 12px;
        bottom: 60px;
        left: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        max-height: 60vh; /* Usar altura relativa ao viewport */
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: rgba(0,0,0,0.3) transparent;
      }
      
      /* Estilizar scrollbar para webkit browsers */
      .info.legend::-webkit-scrollbar {
        width: 4px;
      }
      
      .info.legend::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .info.legend::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.3);
        border-radius: 2px;
      }
      
      .info.legend::-webkit-scrollbar-thumb:hover {
        background: rgba(0,0,0,0.5);
      }
      
      /* Indicador de scroll para mobile */
      .info.legend::after {
        content: '';
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        width: 20px;
        height: 2px;
        background: rgba(0,0,0,0.2);
        border-radius: 1px;
        opacity: 0.7;
      }
      
      /* Melhorar contraste e legibilidade */
      .info.legend {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0,0,0,0.1);
      }
      
      .info.legend h4 {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 4px;
      }
      
      .info.legend div {
        margin-bottom: 4px;
        line-height: 1.4;
        font-size: 10px;
      }
      
      .info.legend i {
        width: 14px;
        height: 14px;
        margin-right: 6px;
        border-radius: 2px;
        display: inline-block;
        vertical-align: middle;
        border: 1px solid #ccc;
      }

                                    #north-arrow {
                padding: 3px;
                bottom: 50px;
                right: 15px;
              }

      #north-arrow svg {
        width: 28px;
        height: 28px;
      }
      
      .opacity-control {
        font-size: 12px;
        min-width: 140px;
        max-width: 85vw;
        padding: 8px;
        border-radius: 8px;
      }
      
      #coordinates-display {
        font-size: 10px;
        padding: 3px 6px;
      }

                                    #north-arrow {
                padding: 2px;
                bottom: 40px;
                right: 10px;
              }

      #north-arrow svg {
        width: 24px;
        height: 24px;
      }
      
      #mini-map-container {
        top: 70px;
        left: 10px;
        width: 140px;
        height: 110px;
      }
      
      #mini-map-toggle {
        top: 55px;
        left: 10px;
        padding: 4px 8px;
        font-size: 11px;
      }
      
      /* Controles de zoom sofisticados - Tablet */
      #sophisticated-zoom-controls {
        top: 70px;
        right: 15px;
        padding: 8px;
        gap: 4px;
      }
      
      .zoom-control-btn {
        width: 30px;
        height: 30px;
        font-size: 12px;
        border-radius: 8px;
      }
      
      #zoom-level-display {
        width: 30px;
        height: 20px;
        font-size: 10px;
        border-radius: 6px;
      }
      
      .zoom-reset-btn {
        width: 30px;
        height: 20px;
        font-size: 9px;
        border-radius: 6px;
      }
    }
    
    @media (max-width: 480px) {
      #map-title-bar {
        height: 45px;
        font-size: 0.9rem;
        padding: 0 12px;
        gap: 6px;
      }
      
      #logo-img {
        max-height: 28px;
        padding: 3px;
        border-width: 1px;
      }
      
      #map {
        height: calc(100vh - 45px);
        margin-top: 45px;
      }
      
      .info.legend {
        font-size: 9px;
        font-weight: 400;
        width: 120px;
        padding: 8px;
        box-sizing: border-box;
        border-radius: 10px;
        bottom: 24px;
        left: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        max-height: 300px;
        overflow: auto;
      }
      
      .info.legend h4 {
        font-size: 9px;
      }
      
      .opacity-control {
        font-size: 11px;
        min-width: 120px;
        max-width: 80vw;
        padding: 6px;
      }
      
      #mini-map-container {
        top: 60px;
        left: 8px;
        width: 120px;
        height: 90px;
      }
      
      #mini-map-toggle {
        top: 50px;
        left: 8px;
        padding: 3px 6px;
        font-size: 10px;
      }
      
      /* Controles de zoom sofisticados - Mobile */
      #sophisticated-zoom-controls {
        top: 60px;
        right: 10px;
        padding: 6px;
        gap: 3px;
        flex-direction: row; /* Mudan√ßa para horizontal */
      }
      
      .zoom-control-btn {
        width: 28px;
        height: 28px;
        font-size: 12px;
        border-radius: 6px;
      }
      
      #zoom-level-display {
        width: 28px;
        height: 18px;
        font-size: 9px;
        border-radius: 4px;
      }
      
      .zoom-reset-btn {
        width: 28px;
        height: 18px;
        font-size: 8px;
        border-radius: 4px;
      }
      
      /* ===== MELHORIAS ESPEC√çFICAS PARA MOBILE ===== */
      
      /* Bot√µes maiores para touch */
      .control-btn {
        min-width: 44px;
        min-height: 44px;
        touch-action: manipulation;
      }
      
      /* Reposicionamento dos bot√µes para evitar sobreposi√ß√£o com o t√≠tulo */
      /* Bot√µes organizados verticalmente abaixo dos controles de zoom */
      #about-btn { 
        right: 20px; 
        top: 110px; /* Posicionado abaixo dos controles de zoom horizontais */
        width: 44px;
        height: 44px;
      }
      #fullscreen-btn { 
        right: 20px; 
        top: 160px; /* 110px + 44px + 6px gap */
        width: 44px;
        height: 44px;
      }
      #measurement-toggle { 
        right: 20px; 
        top: 210px; /* 160px + 44px + 6px gap */
        width: 44px;
        height: 44px;
      }
      #layers-toggle { 
        right: 20px; 
        top: 260px; /* 210px + 44px + 6px gap */
        width: 44px;
        height: 44px;
      }
      #basemap-toggle { 
        right: 20px; 
        top: 310px; /* 260px + 44px + 6px gap */
        width: 44px;
        height: 44px;
      }
      
      /* Legendas com scroll melhorado */
      .info.legend {
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }
      
      /* Feedback visual para bot√µes */
      .control-btn:active {
        transform: scale(0.95);
        background: rgba(255, 255, 255, 0.8);
      }
      
      /* Estilo adicional para os bot√µes verticais no mobile */
      #about-btn, #fullscreen-btn, #measurement-toggle, #layers-toggle, #basemap-toggle {
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      
      #about-btn:hover, #fullscreen-btn:hover, #measurement-toggle:hover, #layers-toggle:hover, #basemap-toggle:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.92) 100%);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transform: scale(1.05);
      }
      
      /* Preven√ß√£o de zoom indesejado e melhoria do scroll da legenda */
      .info.legend {
        touch-action: manipulation;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        max-height: 60vh; /* Usar altura relativa ao viewport */
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-color: rgba(0,0,0,0.3) transparent;
      }
      
      /* Estilizar scrollbar para webkit browsers */
      .info.legend::-webkit-scrollbar {
        width: 4px;
      }
      .info.legend::-webkit-scrollbar-track {
        background: transparent;
      }
      .info.legend::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.3);
        border-radius: 2px;
      }
      .info.legend::-webkit-scrollbar-thumb:hover {
        background: rgba(0,0,0,0.5);
      }
      
      /* Indicador de scroll para mobile */
      .info.legend::after {
        content: '';
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        width: 20px;
        height: 2px;
        background: rgba(0,0,0,0.2);
        border-radius: 1px;
        opacity: 0.7;
      }
      
      /* Melhorar contraste e legibilidade */
      .info.legend {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(0,0,0,0.1);
      }
      .info.legend h4 {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 4px;
      }
      .info.legend div {
        margin-bottom: 4px;
        line-height: 1.4;
        font-size: 10px;
      }
      .info.legend i {
        width: 14px;
        height: 14px;
        margin-right: 6px;
        border-radius: 2px;
        display: inline-block;
        vertical-align: middle;
        border: 1px solid #ccc;
      }
      
          .opacity-control {
      touch-action: manipulation;
    }
    
    /* Bot√£o de toggle da legenda - apenas mobile */
    .mobile-only {
      display: none;
    }
    
    #legend-toggle-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 2100;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 1.2rem;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    #legend-toggle-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    }
    
    #legend-toggle-btn:active {
      transform: scale(0.95);
    }
    
    /* Melhor contraste para mobile */
      #coordinates-display {
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        font-weight: 600;
      }
      
      /* Indicador de carregamento para mobile */
      .loading-indicator {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 9999;
        display: none;
      }
      
      /* Mostrar bot√£o de toggle da legenda apenas no mobile */
      .mobile-only {
        display: block !important;
      }
      
      /* Estado inicial da legenda no mobile - oculta */
      .info.legend {
        display: none;
      }
      
      /* Classe para mostrar a legenda */
      .info.legend.show {
        display: block !important;
      }
    }
    
    /* ===== MELHORIAS PARA TABLET ===== */
    @media (min-width: 481px) and (max-width: 768px) {
      /* Otimiza√ß√µes espec√≠ficas para tablet */
      .control-btn {
        min-width: 40px;
        min-height: 40px;
      }
      
      .info.legend {
        max-height: 400px;
        width: 160px;
      }
      
      #mini-map-container {
        width: 160px;
        height: 120px;
      }
    }
    
    /* ===== LABELS DOS BAIRROS ===== */
    .bairro-label {
      background: rgba(255,255,255,0.85);
      color: #388e3c;
      font-size: 13px;
      font-weight: bold;
      border-radius: 6px;
      border: 1px solid #bdbdbd;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 2px 7px;
      pointer-events: none;
      white-space: nowrap;
      text-shadow: 0 1px 0 #fff;
    }
    
    /* ===== PAIN√âIS DE CONTROLE ===== */
    #layers-panel, #basemap-panel {
      font-family: 'Inter', sans-serif;
      font-size: 13px;
    }
    
    #layers-panel h4, #basemap-panel h4 {
      color: #333;
      font-weight: 600;
      margin: 0 0 10px 0;
    }
    
    #layers-panel div, #basemap-panel div {
      transition: background-color 0.2s ease;
    }
    
    #layers-panel div:hover, #basemap-panel div:hover {
      background-color: rgba(0,0,0,0.05);
      border-radius: 4px;
    }
    

    

  </style>
</head>
<body>
  <!-- Header -->
  <div id="map-title-bar">
    <img src="imagem_gerada.png" alt="Logo" id="logo-img" />
    <span id="map-title-text">WEBGIS DO MUNIC√çPIO DE GAR√áA-SP</span>
    <button id="about-btn" class="control-btn" title="Sobre o Autor" onclick="openAboutModal()">‚ÑπÔ∏è</button>
    <button id="fullscreen-btn" class="control-btn" title="Tela Cheia" onclick="toggleFullscreen()">‚õ∂</button>
    <button id="measurement-toggle" class="control-btn" title="Ferramentas de Medi√ß√£o" onclick="toggleMeasurementPanel()">üìè</button>
    <button id="layers-toggle" class="control-btn" title="Camadas" onclick="toggleLayersPanel()">üóÇÔ∏è</button>
    <button id="basemap-toggle" class="control-btn" title="Mapas de Fundo" onclick="toggleBasemapPanel()">üó∫Ô∏è</button>
  </div>

  <!-- Bot√£o de Toggle da Legenda (Mobile) -->
  <button id="legend-toggle-btn" class="control-btn mobile-only" title="Mostrar/Ocultar Legenda" onclick="toggleLegend()">üìã</button>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Indicador de Carregamento (Mobile) -->
  <div class="loading-indicator" id="loading-indicator">
    <span>üîÑ Carregando...</span>
  </div>

  <!-- Mini-mapa (Overview Map) -->
  <div id="mini-map-container">
    <div id="mini-map"></div>
  </div>
  
  <!-- Bot√£o para mostrar/ocultar mini-mapa -->
  <button id="mini-map-toggle" title="Ocultar Mini Mapa">üó∫Ô∏è Ocultar</button>

  <!-- Coordenadas -->
  <div id="coordinates-display">Lat. 0.000000 ; Long. 0.000000</div>

  <!-- Modal Sobre -->
  <div id="about-modal">
    <div class="modal-content">
      <button id="close-modal" onclick="closeAboutModal()">&times;</button>
      <!-- Header com gradiente -->
      <div class="about-header">
        <div class="author-avatar">
          <span class="avatar-icon">üë®‚Äçüíª</span>
        </div>
                                      <div class="author-info">
                  <h2>Leonardo Vig√°rio Moreira de Castro</h2>
                  <p class="author-title">Ge√≥logo & Especialista em Geoprocessamento</p>
                  <p class="author-subtitle">Sensoriamento Remoto</p>
                </div>
      </div>

      <!-- Conte√∫do principal -->
      <div class="about-content">
        <!-- Informa√ß√µes de contato -->
        <div class="contact-section">
          <h3>üìû Informa√ß√µes de Contato</h3>
          <div class="contact-grid">
            <div class="contact-item">
              <span class="contact-icon">üíº</span>
              <div class="contact-details">
                <strong>LinkedIn</strong>
                <a href="https://www.linkedin.com/in/leonardovigario/" target="_blank" rel="noopener">linkedin.com/in/leonardovigario</a>
              </div>
            </div>
            <div class="contact-item">
              <span class="contact-icon">üì±</span>
              <div class="contact-details">
                <strong>WhatsApp</strong>
                <a href="https://wa.me/5531975837360" target="_blank" rel="noopener">(31) 97583-7360</a>
              </div>
            </div>
            <div class="contact-item">
              <span class="contact-icon">‚úâÔ∏è</span>
              <div class="contact-details">
                <strong>E-mail</strong>
                <a href="mailto:leonardovigario@hotmail.com">leonardovigario@hotmail.com</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Sobre o projeto -->
        <div class="project-section">
          <h3>üåç Sobre o Projeto</h3>
          <div class="project-info">
            <p>Este WebGIS foi desenvolvido para analisar as principais caracter√≠sticas f√≠sicas e qu√≠micas do munic√≠pio de <strong>Gar√ßa-SP</strong> e sua regi√£o, oferecendo uma plataforma interativa e completa para visualiza√ß√£o e an√°lise de dados geogr√°ficos.</p>
          </div>
        </div>

        <!-- Tecnologias utilizadas -->
        <div class="tech-section">
          <h3>üõ†Ô∏è Tecnologias Utilizadas</h3>
          <div class="tech-grid">
            <span class="tech-tag">Leaflet.js</span>
            <span class="tech-tag">HTML5</span>
            <span class="tech-tag">CSS3</span>
            <span class="tech-tag">JavaScript</span>
            <span class="tech-tag">GeoJSON</span>
            <span class="tech-tag">WebGIS</span>
          </div>
        </div>

        <!-- Logo do projeto -->
        <div class="project-logo">
          <img src="imagem_gerada.png" alt="Logo Gar√ßa" />
          <p class="logo-caption">Munic√≠pio de Gar√ßa - S√£o Paulo</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Seta Norte -->
  <div id="north-arrow">
    <svg width="32" height="32" viewBox="0 0 32 32">
      <polygon points="16,4 20,20 16,16 12,20" fill="#222"/>
      <text x="16" y="30" text-anchor="middle" font-size="10" fill="#222" font-family="Arial, sans-serif" font-weight="bold">N</text>
    </svg>
  </div>

  <!-- Controles de Zoom Sofisticados -->
  <div id="sophisticated-zoom-controls">
    <button class="zoom-control-btn" id="zoom-in-btn" title="Aumentar Zoom (Ctrl + +)" aria-label="Zoom In">
      <span style="font-size: 1.2em;">+</span>
    </button>
    <div id="zoom-level-display" title="N√≠vel de Zoom Atual">11</div>
    <button class="zoom-control-btn" id="zoom-out-btn" title="Diminuir Zoom (Ctrl + -)" aria-label="Zoom Out">
      <span style="font-size: 1.2em;">‚àí</span>
    </button>
    <button class="zoom-reset-btn" id="zoom-reset-btn" title="Reset para Vista Inicial" aria-label="Reset Zoom">
      üè†
    </button>
  </div>

  <!-- Painel de Ferramentas de Medi√ß√£o -->
  <div id="measurement-panel">
    <div class="panel-header">Ferramentas de Medi√ß√£o</div>
    <button class="measurement-btn" id="distance-btn" title="Medir Dist√¢ncia">
      üìè Medir Dist√¢ncia
    </button>
    <button class="measurement-btn" id="area-btn" title="Medir √Årea">
      üî≤ Medir √Årea
    </button>
    <button class="measurement-btn" id="coordinate-btn" title="Coletar Coordenadas">
      üìç Coletar Coordenadas
    </button>
    <button class="measurement-btn" id="clear-measurements-btn" title="Limpar Medi√ß√µes">
      üóëÔ∏è Limpar Medi√ß√µes
    </button>
  </div>

                      <!-- Go to Button -->
                    <div id="goto-panel">
                      <button id="goto-concha" class="goto-btn" title="Ir para Concha Ac√∫stica">
                        <span class="goto-label">Ir para</span>
                        <i class="fas fa-music"></i>
                        <span>Concha</span>
                      </button>
                      <button id="goto-lago" class="goto-btn" title="Ir para Lago Artificial">
                        <span class="goto-label">Ir para</span>
                        <i class="fas fa-water"></i>
                        <span>Lago</span>
                      </button>
                    </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geometryutil@0.10.0/src/leaflet.geometryutil.js"></script>
  
  <script>
    // ===== VARI√ÅVEIS GLOBAIS =====
    let map;
    let overlays = {};
    let legend;
    
    // Refer√™ncias das camadas
    let camadaLitologia, camadaAquifero, camadaHidro, camadaConcha, camadaLago;
    let camadaMalhaRodoviaria, camadaLimite, camadaViasAcesso, camadaBairros;
    
    // Controle de labels dos bairros
    let bairrosLabelsVisible = true;
    
    // ===== CONTROLE DE CARREGAMENTO MOBILE =====
    let loadingCount = 0;
    
    function showLoadingIndicator() {
      const indicator = document.getElementById('loading-indicator');
      if (indicator && window.innerWidth <= 480) {
        loadingCount++;
        indicator.style.display = 'block';
      }
    }
    
    function hideLoadingIndicator() {
      const indicator = document.getElementById('loading-indicator');
      if (indicator) {
        loadingCount--;
        if (loadingCount <= 0) {
          indicator.style.display = 'none';
          loadingCount = 0;
        }
      }
    }
    
    // ===== MINI MAPA =====
    let miniMap = null;
    let miniMapContainer = null;
    let miniMapToggle = null;
    let miniMapVisible = true;
    
    // ===== INICIALIZA√á√ÉO DO MAPA =====
    function initializeMap() {
      console.log('üó∫Ô∏è Inicializando mapa...');
      
      // Criar mapa
      map = L.map('map', {
        center: [-22.2125, -49.6547], // Centro de Gar√ßa-SP
        zoom: 11,
        zoomControl: false,
        attributionControl: true
      });
      
      // Adicionar controles de zoom sofisticados
      createSophisticatedZoomControls();
      
      // Adicionar barra de escala
      L.control.scale({
        position: 'bottomleft',
        maxWidth: 200,
        metric: true,
        imperial: false
      }).addTo(map);
      
      // Controle de camadas personalizado (sem controle nativo do Leaflet)
      console.log('‚úÖ Controle de camadas personalizado ativo');
      
      console.log('‚úÖ Mapa inicializado');
    }
    
    // ===== BASEMAPS =====
    function initializeBasemaps() {
      console.log('üó∫Ô∏è Inicializando basemaps...');
      
      // Basemaps
      const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      });
      
      const esriImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Tiles ¬© Esri'
      });
      
      const esriLabels = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Labels ¬© Esri'
      });
      
      const esriImageryWithLabels = L.layerGroup([esriImagery, esriLabels]);
      
      const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 19,
        attribution: 'Tiles ¬© Esri'
      });
      
      // Adicionar Esri Sat√©lite + Labels como padr√£o
      esriImageryWithLabels.addTo(map);
      
      // Fun√ß√£o para trocar basemap
      window.setBasemap = function(key) {
        map.eachLayer(function(layer) {
          if (layer === osm || layer === esriImageryWithLabels || layer === esriTopo) {
            map.removeLayer(layer);
          }
        });
        
        if (key === 'osm') osm.addTo(map);
        if (key === 'esri') esriImageryWithLabels.addTo(map);
        if (key === 'topo') esriTopo.addTo(map);
      };
      
      console.log('‚úÖ Basemaps inicializados');
    }
    
    // ===== ESTILOS DAS CAMADAS =====
    const litologiaColors = {
      'Forma√ß√£o Mar√≠lia': '#FFD700',
      'Mar√≠lia': '#FFD700',
      'MAR√çLIA': '#FFD700',
      'Forma√ß√£o Vale do Rio do Peixe': '#8B4513',
      'Vale do Rio do Peixe': '#8B4513',
      'VALE DO RIO DO PEIXE': '#8B4513',
      'Forma√ß√£o Adamantina': '#D2691E',
      'Adamantina': '#D2691E',
      'ADAMANTINA': '#D2691E',
      'Forma√ß√£o Ara√ßatuba': '#CD853F',
      'Ara√ßatuba': '#CD853F',
      'ARA√áATUBA': '#CD853F',
      'Forma√ß√£o Bauru': '#DEB887',
      'Bauru': '#DEB887',
      'BAURU': '#DEB887',
      'default': '#D3D3D3'
    };
    
    const aquiferoColors = {
      'Classe 1s': '#00FF00',
      'Classe 2s': '#00FFFF',
      'Classe 3s': '#0080FF',
      'Classe 4s': '#0000FF',
      'Classe 1': '#00FF00',
      'Classe 2': '#00FFFF',
      'Classe 3': '#0080FF',
      'Classe 4': '#0000FF'
    };
    
    function litologiaStyle(feature) {
      const properties = feature.properties || {};
      const nome = properties.NOME_UNIDA || properties.NOME || properties.FORMACAO || 
                   properties.LITOLOGIA || properties.TIPO_ROCHA || properties.DESCRICAO ||
                   properties.UNIDADE || properties.GRUPO || properties.SUBGRUPO ||
                   properties.ESTRATO || properties.CAMADA;
      
      const color = litologiaColors[nome] || litologiaColors['default'];
      
      return {
        color: color,
        fillColor: color,
        weight: 1,
        fillOpacity: 0.6,
        opacity: 1
      };
    }
    
    function aquiferoStyle(feature) {
      const classe = feature.properties && feature.properties.CLASSE;
      const color = aquiferoColors[classe] || '#99ccff';
      
      return {
        color: color,
        fillColor: color,
        weight: 2,
        fillOpacity: 0.4,
        opacity: 1
      };
    }
    
    function bairrosStyle(feature) {
      return {
        radius: 7,
        color: '#333',
        fillColor: '#8bc34a',
        fillOpacity: 0.85,
        weight: 2,
        opacity: 1
      };
    }
    
    // ===== CARREGAMENTO DE CAMADAS =====
    const layerNames = {
      'MUN_GARCA.geojson': 'Limite Municipal de Gar√ßa-SP',
      'AQUIF_GARCA.geojson': 'Aqu√≠fero de Gar√ßa-SP',
      'LITO_GARCA.geojson': 'Litologia de Gar√ßa-SP',
      'HID_SP.geojson': 'Hidrografia',
      'Concha_GARCA.geojson': 'Concha Ac√∫stica',
      'LagoArtificial_GARCA.geojson': 'Lago Artificial',
      'MalhaRodoviaria.geojson': 'Malha Rodovi√°ria',
      'ViasAcessos_GARCA.geojson': 'Vias Municipais',
      'Bairros_GARCA.geojson': 'Bairros de Gar√ßa-SP'
    };
    
    const layerStyles = {
      'MUN_GARCA.geojson': {color: '#ffff00', weight: 4, fillOpacity: 0, opacity: 1},
      'HID_SP.geojson': {color: '#0066cc', weight: 1, fillOpacity: 0, opacity: 1},
      'Concha_GARCA.geojson': {color: '#ff69b4', weight: 2, fillColor: '#ffb6c1', fillOpacity: 0.6, opacity: 1},
      'LagoArtificial_GARCA.geojson': {color: '#00bcd4', weight: 2, fillColor: '#b2ebf2', fillOpacity: 0.7, opacity: 1},
      'MalhaRodoviaria.geojson': {color: '#e31a1c', weight: 3, fillOpacity: 0, opacity: 1},
      'ViasAcessos_GARCA.geojson': {color: '#ff9800', weight: 2, fillOpacity: 0, opacity: 1}
    };
    
    function addGeoJsonLayer(url, name, style) {
      console.log('üìÅ Carregando camada:', name);
      
      // Mostrar indicador de carregamento apenas em mobile
      showLoadingIndicator();
      
      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Erro ao carregar ' + url + ': ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          let layer;
          
          if (name === 'Bairros_GARCA.geojson') {
            layer = L.geoJSON(data, {
              pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, bairrosStyle(feature));
              },
              onEachFeature: function (feature, lyr) {
                if (feature.properties && feature.properties.name) {
                  const tooltip = lyr.bindTooltip(feature.properties.name, {
                    permanent: true,
                    direction: 'top',
                    className: 'bairro-label',
                    offset: [0, -10]
                  });
                  // Armazenar refer√™ncia ao tooltip para controle posterior
                  lyr.bairroTooltip = tooltip;
                }
                lyr.on('click', function(e) {
                  if (feature.properties) {
                    lyr.bindPopup(createPopupContent(feature.properties, layerNames[name] || name)).openPopup();
                  }
                });
              }
            });
          } else {
            layer = L.geoJSON(data, {
              style: typeof style === 'function' ? style : () => style,
              onEachFeature: function (feature, lyr) {
                lyr.on('click', function(e) {
                  if (feature.properties) {
                    lyr.bindPopup(createPopupContent(feature.properties, layerNames[name] || name)).openPopup();
                  }
                });
              }
            });
          }
          
          overlays[layerNames[name] || name] = layer;
          layer.addTo(map);
          
          // Camada adicionada ao mapa (controle personalizado)
          console.log('‚úÖ Camada adicionada:', layerNames[name] || name);
          console.log('‚úÖ Camada est√° no mapa:', map.hasLayer(layer));
          
          // Guardar refer√™ncias
          if (name === 'LITO_GARCA.geojson') {
            camadaLitologia = layer;
            console.log('‚úÖ Camada Litologia definida:', camadaLitologia);
          }
          if (name === 'AQUIF_GARCA.geojson') {
            camadaAquifero = layer;
            console.log('‚úÖ Camada Aqu√≠fero definida:', camadaAquifero);
            // For√ßar atualiza√ß√£o da legenda ap√≥s carregar aqu√≠fero
            setTimeout(() => {
              console.log('üîÑ For√ßando atualiza√ß√£o da legenda ap√≥s carregar aqu√≠fero...');
              updateLegend();
            }, 500);
          }
          if (name === 'HID_SP.geojson') camadaHidro = layer;
          if (name === 'Concha_GARCA.geojson') camadaConcha = layer;
          if (name === 'LagoArtificial_GARCA.geojson') camadaLago = layer;
          if (name === 'MalhaRodoviaria.geojson') camadaMalhaRodoviaria = layer;
          if (name === 'MUN_GARCA.geojson') camadaLimite = layer;
          if (name === 'ViasAcessos_GARCA.geojson') camadaViasAcesso = layer;
          if (name === 'Bairros_GARCA.geojson') camadaBairros = layer;
          
          console.log('‚úÖ Camada carregada:', layerNames[name] || name);
          
          // Ocultar indicador de carregamento
          hideLoadingIndicator();
        })
        .catch(error => {
          console.error('‚ùå Erro ao carregar camada:', name, error);
          
          // Ocultar indicador de carregamento em caso de erro
          hideLoadingIndicator();
        });
    }
    
    // ===== FUN√á√ïES AUXILIARES =====
    function createPopupContent(properties, layerName) {
      let content = '<div style="min-width: 280px; max-width: 350px; font-family: Arial, sans-serif;">';
      
      // Cabe√ßalho com √≠cone baseado no tipo de camada
      const icon = getLayerIcon(layerName);
      content += '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 16px; margin: -12px -12px 12px -12px; border-radius: 8px 8px 0 0; display: flex; align-items: center; gap: 8px;">';
      content += '<span style="font-size: 18px;">' + icon + '</span>';
      content += '<h4 style="margin: 0; font-size: 16px; font-weight: 600;">' + layerName + '</h4>';
      content += '</div>';
      
      // Conte√∫do espec√≠fico baseado no tipo de camada
      content += getSpecificContent(properties, layerName);
      
      content += '</div>';
      return content;
    }
    
    function getLayerIcon(layerName) {
      const icons = {
        'Litologia de Gar√ßa-SP': 'ü™®',
        'Aqu√≠fero de Gar√ßa-SP': 'üíß',
        'Hidrografia': 'üåä',
        'Limite Municipal de Gar√ßa-SP': 'üèõÔ∏è',
        'Bairros de Gar√ßa-SP': 'üèòÔ∏è',
        'Concha Ac√∫stica': 'üéµ',
        'Lago Artificial': 'üèûÔ∏è',
        'Malha Rodovi√°ria': 'üõ£Ô∏è',
        'Vias Municipais': 'üõ§Ô∏è'
      };
      return icons[layerName] || 'üìç';
    }
    
    function getSpecificContent(properties, layerName) {
      let content = '<div style="padding: 0 4px;">';
      
      switch(layerName) {
        case 'Litologia de Gar√ßa-SP':
          content += getLitologiaContent(properties);
          break;
        case 'Aqu√≠fero de Gar√ßa-SP':
          content += getAquiferoContent(properties);
          break;
        case 'Hidrografia':
          content += getHidrografiaContent(properties);
          break;
        case 'Bairros de Gar√ßa-SP':
          content += getBairrosContent(properties);
          break;
        case 'Concha Ac√∫stica':
          content += getConchaContent(properties);
          break;
        case 'Lago Artificial':
          content += getLagoContent(properties);
          break;
        case 'Malha Rodovi√°ria':
          content += getRodoviaContent(properties);
          break;
        case 'Vias Municipais':
          content += getViasContent(properties);
          break;
        case 'Limite Municipal de Gar√ßa-SP':
          content += getMunicipioContent(properties);
          break;
        default:
          content += getDefaultContent(properties);
      }
      
      content += '</div>';
      return content;
    }
    
    function getLitologiaContent(properties) {
      let content = '';
      
      if (properties.NOME_UNIDA) {
        content += '<div style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 12px;">';
        content += '<h5 style="margin: 0 0 8px 0; color: #495057; font-size: 14px;">üèîÔ∏è Forma√ß√£o Geol√≥gica</h5>';
        content += '<p style="margin: 0; font-weight: 600; color: #212529; font-size: 15px;">' + properties.NOME_UNIDA + '</p>';
        content += '</div>';
      }
      
      if (properties.LITOTIPO1) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">ü™® Litotipo Principal:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.LITOTIPO1 + '</span>';
        content += '</div>';
      }
      
      if (properties.IDADE_MAX && properties.IDADE_MIN) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">‚è∞ Idade:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.IDADE_MIN + ' - ' + properties.IDADE_MAX + ' Ma</span>';
        content += '</div>';
      }
      
      if (properties.ERA_MAXIMA) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üåç Era:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.ERA_MAXIMA + ' - ' + properties.PERIOD_MAX + '</span>';
        content += '</div>';
      }
      
      if (properties.AMBSED) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üåä Ambiente Sedimentar:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.AMBSED + '</span>';
        content += '</div>';
      }
      
      if (properties.SHAPE_Area) {
        const area = (properties.SHAPE_Area * 100).toFixed(2);
        content += '<div style="background: #e3f2fd; padding: 8px; border-radius: 4px; margin-top: 12px;">';
        content += '<span style="font-weight: 600; color: #1976d2; font-size: 12px;">üìê √Årea: ' + area + ' km¬≤</span>';
        content += '</div>';
      }
      
      return content;
    }
    
    function getAquiferoContent(properties) {
      let content = '';
      
      if (properties.NOME_AQUI) {
        content += '<div style="background: #e3f2fd; padding: 10px; border-radius: 6px; margin-bottom: 12px;">';
        content += '<h5 style="margin: 0 0 8px 0; color: #1976d2; font-size: 14px;">üíß Aqu√≠fero</h5>';
        content += '<p style="margin: 0; font-weight: 600; color: #0d47a1; font-size: 15px;">' + properties.NOME_AQUI + '</p>';
        content += '</div>';
      }
      
      if (properties.CLASSE) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üìä Classe:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.CLASSE + '</span>';
        content += '</div>';
      }
      
      if (properties.INT_VAZ√ÉO) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üí¶ Vaz√£o (m¬≥/h):</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.INT_VAZ√ÉO + '</span>';
        content += '</div>';
      }
      
      if (properties.ROCHA_PRIN) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">ü™® Rocha Principal:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.ROCHA_PRIN + '</span>';
        content += '</div>';
      }
      
      if (properties.TIPO_CARAC) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üîç Caracter√≠sticas:</span><br>';
        content += '<span style="color: #212529; font-size: 13px; line-height: 1.4;">' + properties.TIPO_CARAC + '</span>';
        content += '</div>';
      }
      
      return content;
    }
    
    function getHidrografiaContent(properties) {
      let content = '';
      
      // Nome da hidrografia em destaque
      if (properties.NM_NOME) {
        content += '<div style="background: #e8f5e8; padding: 10px; border-radius: 6px; margin-bottom: 12px;">';
        content += '<h5 style="margin: 0 0 8px 0; color: #2e7d32; font-size: 14px;">üåä Nome do Curso d\'√Ågua</h5>';
        content += '<p style="margin: 0; font-weight: 600; color: #1b5e20; font-size: 15px;">' + properties.NM_NOME + '</p>';
        content += '</div>';
      }
      
      if (properties.CD_TIPO_EL) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üèûÔ∏è Tipo:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.CD_TIPO_EL + '</span>';
        content += '</div>';
      }
      
      if (properties.CD_CLASSE_) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üìè Ordem:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.CD_CLASSE_ + '</span>';
        content += '</div>';
      }
      
      if (properties.CD_FLUXO) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üíß Fluxo:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.CD_FLUXO + '</span>';
        content += '</div>';
      }
      
      if (properties.MD_EXTENSA) {
        const extensao = properties.MD_EXTENSA.toFixed(2);
        content += '<div style="background: #e8f5e8; padding: 8px; border-radius: 4px; margin-top: 12px;">';
        content += '<span style="font-weight: 600; color: #2e7d32; font-size: 12px;">üìê Extens√£o: ' + extensao + ' km</span>';
        content += '</div>';
      }
      
      return content;
    }
    
    function getBairrosContent(properties) {
      let content = '';
      
      if (properties.name) {
        content += '<div style="background: #fff3e0; padding: 10px; border-radius: 6px; margin-bottom: 12px;">';
        content += '<h5 style="margin: 0 0 8px 0; color: #f57c00; font-size: 14px;">üèòÔ∏è Bairro</h5>';
        content += '<p style="margin: 0; font-weight: 600; color: #e65100; font-size: 15px;">' + properties.name + '</p>';
        content += '</div>';
      }
      
      if (properties.osm_id) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üÜî ID OSM:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.osm_id + '</span>';
        content += '</div>';
      }
      
      content += '<div style="background: #fff3e0; padding: 8px; border-radius: 4px; margin-top: 12px;">';
      content += '<span style="font-weight: 600; color: #f57c00; font-size: 12px;">üìç Ponto de Refer√™ncia</span>';
      content += '</div>';
      
      return content;
    }
    
    function getConchaContent(properties) {
      let content = '';
      
      content += '<div style="background: #fce4ec; padding: 10px; border-radius: 6px; margin-bottom: 12px;">';
      content += '<h5 style="margin: 0 0 8px 0; color: #c2185b; font-size: 14px;">üéµ Concha Ac√∫stica</h5>';
      content += '<p style="margin: 0; font-weight: 600; color: #880e4f; font-size: 15px;">Espa√ßo Cultural</p>';
      content += '</div>';
      
      content += '<div style="margin-bottom: 10px;">';
      content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üé≠ Tipo:</span><br>';
      content += '<span style="color: #212529; font-size: 14px;">Concha Ac√∫stica</span>';
      content += '</div>';
      
      content += '<div style="margin-bottom: 10px;">';
      content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üìç Localiza√ß√£o:</span><br>';
      content += '<span style="color: #212529; font-size: 14px;">Gar√ßa - SP</span>';
      content += '</div>';
      
      return content;
    }
    
    function getLagoContent(properties) {
      let content = '';
      
      content += '<div style="background: #e1f5fe; padding: 10px; border-radius: 6px; margin-bottom: 12px;">';
      content += '<h5 style="margin: 0 0 8px 0; color: #0277bd; font-size: 14px;">üèûÔ∏è Lago Artificial</h5>';
      content += '<p style="margin: 0; font-weight: 600; color: #01579b; font-size: 15px;">Corpo d\'√Ågua</p>';
      content += '</div>';
      
      content += '<div style="margin-bottom: 10px;">';
      content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üíß Tipo:</span><br>';
      content += '<span style="color: #212529; font-size: 14px;">Lago Artificial</span>';
      content += '</div>';
      
      content += '<div style="margin-bottom: 10px;">';
      content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üìç Localiza√ß√£o:</span><br>';
      content += '<span style="color: #212529; font-size: 14px;">Gar√ßa - SP</span>';
      content += '</div>';
      
      return content;
    }
    
    function getRodoviaContent(properties) {
      let content = '';
      
      // Nome da rodovia em destaque
      if (properties.Rodovia) {
        content += '<div style="background: #ffebee; padding: 10px; border-radius: 6px; margin-bottom: 12px;">';
        content += '<h5 style="margin: 0 0 8px 0; color: #c62828; font-size: 14px;">üõ£Ô∏è Nome da Rodovia</h5>';
        content += '<p style="margin: 0; font-weight: 600; color: #b71c1c; font-size: 15px;">' + properties.Rodovia + '</p>';
        content += '</div>';
      }
      
      if (properties.TipoRodovi) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üõ£Ô∏è Tipo:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.TipoRodovi + '</span>';
        content += '</div>';
      }
      
      if (properties.Orientacao) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üß≠ Orienta√ß√£o:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.Orientacao + '</span>';
        content += '</div>';
      }
      
      if (properties.Origem) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üèõÔ∏è Origem:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.Origem + '</span>';
        content += '</div>';
      }
      
      if (properties.Municipio) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üèòÔ∏è Munic√≠pio:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.Municipio + '</span>';
        content += '</div>';
      }
      
      return content;
    }
    
    function getViasContent(properties) {
      let content = '';
      
      // Nome da via em destaque
      if (properties.name) {
        content += '<div style="background: #fff8e1; padding: 10px; border-radius: 6px; margin-bottom: 12px;">';
        content += '<h5 style="margin: 0 0 8px 0; color: #f57f17; font-size: 14px;">üõ§Ô∏è Nome da Via</h5>';
        content += '<p style="margin: 0; font-weight: 600; color: #e65100; font-size: 15px;">' + properties.name + '</p>';
        content += '</div>';
      }
      
      if (properties.highway) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üõ§Ô∏è Tipo:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.highway + '</span>';
        content += '</div>';
      }
      
      if (properties.surface) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üõ£Ô∏è Superf√≠cie:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.surface + '</span>';
        content += '</div>';
      }
      
      if (properties.ref) {
        content += '<div style="margin-bottom: 10px;">';
        content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üõ£Ô∏è Refer√™ncia:</span><br>';
        content += '<span style="color: #212529; font-size: 14px;">' + properties.ref + '</span>';
        content += '</div>';
      }
      
      return content;
    }
    
    function getMunicipioContent(properties) {
      let content = '';
      
      content += '<div style="background: #f3e5f5; padding: 10px; border-radius: 6px; margin-bottom: 12px;">';
      content += '<h5 style="margin: 0 0 8px 0; color: #7b1fa2; font-size: 14px;">üèõÔ∏è Limite Municipal</h5>';
      content += '<p style="margin: 0; font-weight: 600; color: #4a148c; font-size: 15px;">Gar√ßa - SP</p>';
      content += '</div>';
      
      content += '<div style="margin-bottom: 10px;">';
      content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üèõÔ∏è Tipo:</span><br>';
      content += '<span style="color: #212529; font-size: 14px;">Limite Municipal</span>';
      content += '</div>';
      
      content += '<div style="margin-bottom: 10px;">';
      content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">üìç Munic√≠pio:</span><br>';
      content += '<span style="color: #212529; font-size: 14px;">Gar√ßa - S√£o Paulo</span>';
      content += '</div>';
      
      return content;
    }
    
    function getDefaultContent(properties) {
      let content = '';
      
      // Mostrar apenas as 5 propriedades mais relevantes
      const relevantKeys = Object.keys(properties).slice(0, 5);
      
      relevantKeys.forEach(key => {
        if (properties[key] !== null && properties[key] !== undefined && properties[key] !== '') {
          content += '<div style="margin-bottom: 8px;">';
          content += '<span style="font-weight: 600; color: #495057; font-size: 13px;">' + key + ':</span><br>';
          content += '<span style="color: #212529; font-size: 14px;">' + properties[key] + '</span>';
          content += '</div>';
        }
      });
      
      return content;
    }
    
    function reorderLayers() {
      if (camadaLitologia && map.hasLayer(camadaLitologia)) camadaLitologia.bringToBack();
      if (camadaAquifero && map.hasLayer(camadaAquifero)) camadaAquifero.bringToFront();
      if (camadaHidro && map.hasLayer(camadaHidro)) camadaHidro.bringToFront();
      if (camadaLimite && map.hasLayer(camadaLimite)) camadaLimite.bringToFront();
      if (camadaConcha && map.hasLayer(camadaConcha)) camadaConcha.bringToFront();
      if (camadaLago && map.hasLayer(camadaLago)) camadaLago.bringToFront();
      if (camadaMalhaRodoviaria && map.hasLayer(camadaMalhaRodoviaria)) camadaMalhaRodoviaria.bringToFront();
      if (camadaViasAcesso && map.hasLayer(camadaViasAcesso)) camadaViasAcesso.bringToFront();
      if (camadaBairros && map.hasLayer(camadaBairros)) camadaBairros.bringToFront();
    }
    
    // ===== CONTROLES DE INTERFACE =====
    function openAboutModal() {
      document.getElementById('about-modal').style.display = 'flex';
    }
    
    function closeAboutModal() {
      document.getElementById('about-modal').style.display = 'none';
    }
    
    function toggleFullscreen() {
      const mapContainer = document.getElementById('map');
      const titleText = document.getElementById('map-title-text');
      
      if (!document.fullscreenElement) {
        if (mapContainer.requestFullscreen) {
          mapContainer.requestFullscreen();
        } else if (mapContainer.webkitRequestFullscreen) {
          mapContainer.webkitRequestFullscreen();
        } else if (mapContainer.msRequestFullscreen) {
          mapContainer.msRequestFullscreen();
        }
        if (titleText) titleText.style.display = 'none';
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
        if (titleText) titleText.style.display = 'inline';
      }
    }
    
    function toggleMeasurementPanel() {
      console.log('üìè Toggle painel medi√ß√£o - Funcionalidade em desenvolvimento');
    }
    
    function toggleLayersPanel() {
      console.log('üóÇÔ∏è Toggle painel camadas - Funcionalidade em desenvolvimento');
    }
    
    function toggleBasemapPanel() {
      console.log('üó∫Ô∏è Toggle painel basemap - Funcionalidade em desenvolvimento');
    }
    
    // ===== TOGGLE DA LEGENDA (MOBILE) =====
    function toggleLegend() {
      const legend = document.querySelector('.info.legend');
      const toggleBtn = document.getElementById('legend-toggle-btn');
      
      if (!legend) {
        console.error('‚ùå Legenda n√£o encontrada');
        return;
      }
      
      if (legend.classList.contains('show')) {
        // Ocultar legenda
        legend.classList.remove('show');
        toggleBtn.innerHTML = 'üìã';
        toggleBtn.title = 'Mostrar Legenda';
        console.log('üëÅÔ∏è Legenda ocultada');
      } else {
        // Mostrar legenda
        legend.classList.add('show');
        toggleBtn.innerHTML = 'üëÅÔ∏è';
        toggleBtn.title = 'Ocultar Legenda';
        console.log('üìã Legenda mostrada');
      }
    }
    
    // ===== COORDENADAS =====
    function updateCoordinates(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      const coordsDisplay = document.getElementById('coordinates-display');
      if (coordsDisplay) {
        coordsDisplay.textContent = 'Lat. ' + lat + ' ; Long. ' + lng;
      }
    }
    
    // ===== LEGENDA DIN√ÇMICA =====
    function createLegend() {
      console.log('üîÑ Criando legenda...');
      legend = L.control({position: 'bottomleft'});
      
      legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = '<h4>Legenda</h4>';
        console.log('‚úÖ Elemento da legenda criado:', div);
        return div;
      };
      
      legend.addTo(map);
      console.log('‚úÖ Legenda adicionada ao mapa');
    }
    
    function updateLegend() {
      const legendDiv = document.querySelector('.info.legend');
      if (!legendDiv) {
        console.error('‚ùå Elemento da legenda n√£o encontrado');
        return;
      }
      
      console.log('üîÑ Atualizando legenda...');
      let legendContent = '<h4>Legenda</h4>';
      
      // Itens fixos da legenda
      const legendItems = [
        {name: 'Bairros', color: '#8bc34a', type: 'point'},
        {name: 'Hidrografia', color: '#0066cc', type: 'line'},
        {name: 'Malha Rodovi√°ria', color: '#e31a1c', type: 'line'},
        {name: 'Vias Municipais', color: '#ff9800', type: 'line'},
        {name: 'Limite Municipal', color: 'transparent', type: 'polygon', border: '#ffff00'},
        {name: 'Concha Ac√∫stica', color: '#ffb6c1', type: 'polygon', border: '#ff69b4'},
        {name: 'Lago Artificial', color: '#b2ebf2', type: 'polygon', border: '#00bcd4'}
      ];
      
      // Adicionar itens da legenda
      legendItems.forEach(item => {
        if (item.type === 'point') {
          legendContent += `<div><i style="background: ${item.color}; width: 18px; height: 18px; border-radius: 50%; display: inline-block; margin-right: 8px;"></i>${item.name}</div>`;
        } else if (item.type === 'line') {
          legendContent += `<div><i style="background: ${item.color}; width: 18px; height: 2px; display: inline-block; margin-right: 8px;"></i>${item.name}</div>`;
        } else if (item.type === 'polygon') {
          legendContent += `<div><i style="background: ${item.color}; width: 18px; height: 18px; border: 2px solid ${item.border}; display: inline-block; margin-right: 8px;"></i>${item.name}</div>`;
        }
      });
      
      // Adicionar litologia se estiver vis√≠vel
      if (camadaLitologia && map.hasLayer(camadaLitologia)) {
        console.log('‚úÖ Adicionando litologia √† legenda');
        legendContent += '<h4 style="margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px;">LITOLOGIA</h4>';
        
        // Coletar litologias √∫nicas dos dados
        const litologiasUnicas = new Set();
        camadaLitologia.eachLayer(function(layer) {
          if (layer.feature && layer.feature.properties && layer.feature.properties.NOME_UNIDA) {
            litologiasUnicas.add(layer.feature.properties.NOME_UNIDA);
          }
        });
        
        // Converter para array e ordenar alfabeticamente
        const litologias = Array.from(litologiasUnicas).sort();
        console.log('üìã Litologias encontradas:', litologias);
        
        litologias.forEach(lit => {
          const color = litologiaColors[lit] || litologiaColors['default'];
          legendContent += `<div><i style="background: ${color}; width: 18px; height: 18px; border: 1px solid #333; display: inline-block; margin-right: 8px;"></i>${lit}</div>`;
        });
      } else {
        console.log('‚ùå Litologia n√£o est√° vis√≠vel ou n√£o foi carregada');
      }
      
      // Adicionar aqu√≠fero se estiver vis√≠vel
      if (camadaAquifero && map.hasLayer(camadaAquifero)) {
        console.log('‚úÖ Adicionando aqu√≠fero √† legenda');
        console.log('üìã Camada Aqu√≠fero:', camadaAquifero);
        console.log('üìã Mapa tem camada Aqu√≠fero:', map.hasLayer(camadaAquifero));
        
        legendContent += '<h4 style="margin-top: 15px; border-top: 1px solid #ccc; padding-top: 10px;">AQU√çFERO</h4>';
        
        // Coletar classes √∫nicas dos dados
        const classesUnicas = new Set();
        let layerCount = 0;
        
        camadaAquifero.eachLayer(function(layer) {
          layerCount++;
          console.log(`üîç Verificando layer ${layerCount}:`, layer);
          if (layer.feature && layer.feature.properties && layer.feature.properties.CLASSE) {
            const classe = layer.feature.properties.CLASSE;
            classesUnicas.add(classe);
            console.log(`‚úÖ Classe encontrada: ${classe}`);
          } else {
            console.log(`‚ùå Layer ${layerCount} n√£o tem propriedade CLASSE:`, layer.feature?.properties);
          }
        });
        
        console.log(`üìä Total de layers verificados: ${layerCount}`);
        
        // Converter para array e ordenar alfabeticamente
        const classes = Array.from(classesUnicas).sort();
        console.log('üìã Classes de aqu√≠fero encontradas:', classes);
        
        if (classes.length === 0) {
          legendContent += '<div style="color: #666; font-style: italic;">Nenhuma classe encontrada</div>';
        } else {
          classes.forEach(classe => {
            const color = aquiferoColors[classe] || '#99ccff';
            legendContent += `<div><i style="background: ${color}; width: 18px; height: 18px; border: 1px solid #333; display: inline-block; margin-right: 8px;"></i>${classe}</div>`;
          });
        }
      } else {
        console.log('‚ùå Aqu√≠fero n√£o est√° vis√≠vel ou n√£o foi carregado');
        console.log('üìã Camada Aqu√≠fero existe:', !!camadaAquifero);
        console.log('üìã Camada est√° no mapa:', camadaAquifero ? map.hasLayer(camadaAquifero) : 'N/A');
      }
      
      legendDiv.innerHTML = legendContent;
      console.log('‚úÖ Legenda atualizada com sucesso');
      console.log('üìÑ Conte√∫do da legenda:', legendContent);
    }
    
    // ===== PAIN√âIS DE CONTROLE =====
    function createControlPanels() {
      // Painel de camadas com controles integrados
      const layersPanel = document.createElement('div');
      layersPanel.id = 'layers-panel';
      layersPanel.style.cssText = `
        position: absolute;
        top: 70px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        padding: 12px;
        z-index: 1000;
        display: none;
        min-width: 250px;
        max-height: 500px;
        overflow-y: auto;
      `;
      
      // Definir camadas e suas configura√ß√µes
      const layerConfigs = [
        { name: 'Litologia', layerKey: 'LITO_GARCA.geojson', color: '#8B4513', hasOpacity: true },
        { name: 'Aqu√≠fero', layerKey: 'AQUIF_GARCA.geojson', color: '#0066cc', hasOpacity: true },
        { name: 'Hidrografia', layerKey: 'HID_SP.geojson', color: '#0066cc', hasOpacity: false },
        { name: 'Limite Municipal', layerKey: 'MUN_GARCA.geojson', color: '#ffff00', hasOpacity: false },
        { name: 'Bairros', layerKey: 'Bairros_GARCA.geojson', color: '#8bc34a', hasOpacity: false },
        { name: 'Concha Ac√∫stica', layerKey: 'Concha_GARCA.geojson', color: '#ffb6c1', hasOpacity: true },
        { name: 'Lago Artificial', layerKey: 'LagoArtificial_GARCA.geojson', color: '#b2ebf2', hasOpacity: true },
        { name: 'Malha Rodovi√°ria', layerKey: 'MalhaRodoviaria.geojson', color: '#e31a1c', hasOpacity: false },
        { name: 'Vias Municipais', layerKey: 'ViasAcessos_GARCA.geojson', color: '#ff9800', hasOpacity: false }
      ];
      
      let panelContent = '<h4 style="margin: 0 0 15px 0; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Camadas</h4>';
      
      // Criar controles para cada camada
      layerConfigs.forEach(config => {
        const layerId = config.layerKey.replace('.geojson', '').toLowerCase();
        panelContent += `
          <div style="margin: 8px 0; padding: 8px; border: 1px solid #eee; border-radius: 4px; background: #f9f9f9;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: ${config.hasOpacity ? '8px' : '0'};">
              <label style="cursor: pointer; display: flex; align-items: center; font-size: 14px;">
                <input type="checkbox" id="layer-${layerId}" style="margin-right: 8px;" onchange="toggleLayer('${config.layerKey}', this.checked)">
                <span style="color: ${config.color}; font-weight: 500;">${config.name}</span>
              </label>
            </div>
            ${config.hasOpacity ? `
              <div style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                <span>Opacidade:</span>
                <input type="range" 
                       id="opacity-${layerId}" 
                       min="0" max="1" step="0.05" value="0.7" 
                       style="flex: 1; accent-color: ${config.color};"
                       oninput="setLayerOpacity('${config.layerKey}', this.value)"
                       title="Opacidade ${config.name}">
                <span id="opacity-value-${layerId}" style="min-width: 30px; text-align: right;">70%</span>
              </div>
            ` : ''}
          </div>
        `;
        
        // Adicionar controle de labels para Bairros
        if (config.layerKey === 'Bairros_GARCA.geojson') {
          panelContent += `
            <div style="margin: 4px 0 8px 16px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; background: #f0f8f0; border-left: 3px solid #8bc34a;">
              <label style="cursor: pointer; display: flex; align-items: center; font-size: 13px;">
                <input type="checkbox" id="bairros-labels-toggle" style="margin-right: 6px;" checked onchange="toggleBairrosLabels(this.checked)">
                <span style="color: #2e7d32; font-weight: 500;">üè∑Ô∏è Labels dos Bairros</span>
              </label>
            </div>
          `;
        }
      });
      
      layersPanel.innerHTML = panelContent;
      document.body.appendChild(layersPanel);
      
      // Painel de basemaps
      const basemapPanel = document.createElement('div');
      basemapPanel.id = 'basemap-panel';
      basemapPanel.style.cssText = `
        position: absolute;
        top: 70px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        padding: 12px;
        z-index: 1000;
        display: none;
        min-width: 180px;
      `;
      basemapPanel.innerHTML = `
        <h4 style="margin: 0 0 10px 0; border-bottom: 1px solid #ccc; padding-bottom: 5px;">Mapas Base</h4>
        <div style="margin: 5px 0;"><input type="radio" name="basemap" value="osm" id="basemap-osm"><label for="basemap-osm" style="margin-left: 8px; cursor: pointer;">OpenStreetMap</label></div>
        <div style="margin: 5px 0;"><input type="radio" name="basemap" value="esri" id="basemap-esri" checked><label for="basemap-esri" style="margin-left: 8px; cursor: pointer;">Esri Sat√©lite</label></div>
        <div style="margin: 5px 0;"><input type="radio" name="basemap" value="topo" id="basemap-topo"><label for="basemap-topo" style="margin-left: 8px; cursor: pointer;">Esri Topogr√°fico</label></div>
      `;
      document.body.appendChild(basemapPanel);
      
      // Event listeners para basemaps
      document.querySelectorAll('input[name="basemap"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.checked) {
            setBasemap(this.value);
          }
        });
      });
      
    }
    
    // ===== FUN√á√ïES DE TOGGLE ATUALIZADAS =====
    function toggleLayersPanel() {
      const panel = document.getElementById('layers-panel');
      const basemapPanel = document.getElementById('basemap-panel');
      
      if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        if (basemapPanel) basemapPanel.style.display = 'none';
      } else {
        panel.style.display = 'none';
      }
    }
    
    function toggleBasemapPanel() {
      const panel = document.getElementById('basemap-panel');
      const layersPanel = document.getElementById('layers-panel');
      
      if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        if (layersPanel) layersPanel.style.display = 'none';
      } else {
        panel.style.display = 'none';
      }
    }
    
    // ===== VARI√ÅVEIS DE MEDI√á√ÉO =====
    let currentMeasurementTool = null;
    let measurementLayers = [];
    let measurementPoints = [];
    let measurementLines = [];
    let measurementPolygons = [];
    let coordinateMarkers = [];
    let measurementResults = [];
    let measurementHistory = [];
    let measurementSettings = {
      units: 'metric',
      precision: 3,
      showCoordinates: true,
      autoSave: true
    };

    // ===== FUN√á√ïES DE MEDI√á√ÉO =====
    function formatDistance(meters) {
      if (measurementSettings.units === 'metric') {
        if (meters >= 1000) {
          return (meters / 1000).toFixed(measurementSettings.precision) + ' km';
        } else {
          return meters.toFixed(measurementSettings.precision) + ' m';
        }
      } else {
        var feet = meters * 3.28084;
        if (feet >= 5280) {
          return (feet / 5280).toFixed(measurementSettings.precision) + ' mi';
        } else {
          return feet.toFixed(measurementSettings.precision) + ' ft';
        }
      }
    }

    function formatArea(squareMeters) {
      if (measurementSettings.units === 'metric') {
        if (squareMeters >= 1000000) {
          return (squareMeters / 1000000).toFixed(measurementSettings.precision) + ' km¬≤';
        } else if (squareMeters >= 10000) {
          return (squareMeters / 10000).toFixed(measurementSettings.precision) + ' ha';
        } else {
          return squareMeters.toFixed(measurementSettings.precision) + ' m¬≤';
        }
      } else {
        var squareFeet = squareMeters * 10.7639;
        if (squareFeet >= 43560) {
          return (squareFeet / 43560).toFixed(measurementSettings.precision) + ' ac';
        } else {
          return squareFeet.toFixed(measurementSettings.precision) + ' ft¬≤';
        }
      }
    }

    function formatCoordinates(latlng) {
      var lat = latlng.lat.toFixed(6);
      var lng = latlng.lng.toFixed(6);
      return 'Lat: ' + lat + '¬∞ | Long: ' + lng + '¬∞';
    }

    function saveMeasurementResult(type, data) {
      var result = {
        id: Date.now(),
        type: type,
        data: data,
        timestamp: new Date().toISOString(),
        coordinates: data.coordinates || []
      };
      
      measurementResults.push(result);
      measurementHistory.push(result);
      
      if (measurementHistory.length > 50) {
        measurementHistory.shift();
      }
      
      console.log('Medi√ß√£o salva:', result);
      return result;
    }

    function createMeasurementMarker(latlng, index, type) {
      var colors = {
        distance: '#ff4444',
        area: '#44ff44',
        angle: '#4444ff',
        coordinate: '#ffaa44'
      };
      
      var icon = L.divIcon({
        className: 'measurement-marker',
        html: '<div style="background: ' + colors[type] + '; color: white; border-radius: 50%; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">' + index + '</div>',
        iconSize: [14, 14]
      });
      
      return L.marker(latlng, {icon: icon});
    }

    function deactivateAllTools() {
      console.log('üîß Desativando todas as ferramentas...');
      
      // Remover event listener se houver uma ferramenta ativa
      if (currentMeasurementTool) {
        if (currentMeasurementTool.clickHandler) {
          console.log('üîß Removendo clickHandler');
          map.off('click', currentMeasurementTool.clickHandler);
        }
        if (currentMeasurementTool.doubleClickHandler) {
          console.log('üîß Removendo doubleClickHandler');
          map.off('dblclick', currentMeasurementTool.doubleClickHandler);
        }
      }
      
      // Limpar qualquer event listener residual
      map.off('click');
      map.off('dblclick');
      
      // Reabilitar doubleClickZoom
      if (map.doubleClickZoom && map.doubleClickZoom.enable) {
        console.log('üîß Reabilitando doubleClickZoom');
        map.doubleClickZoom.enable();
      }
      
      currentMeasurementTool = null;
      document.querySelectorAll('.measurement-btn').forEach(btn => btn.classList.remove('active'));
      map.getContainer().style.cursor = '';
      
      console.log('‚úÖ Ferramentas desativadas');
    }

    // Fun√ß√£o para calcular √°rea de pol√≠gono (aproxima√ß√£o)
    function calculatePolygonArea(points) {
      if (points.length < 3) return 0;
      
      var area = 0;
      for (var i = 0; i < points.length; i++) {
        var j = (i + 1) % points.length;
        area += points[i].lng * points[j].lat;
        area -= points[j].lng * points[i].lat;
      }
      area = Math.abs(area) / 2;
      
      // Converter para √°rea aproximada em metros quadrados
      // Esta √© uma aproxima√ß√£o simples - para maior precis√£o seria necess√°rio usar f√≥rmulas geod√©sicas
      return area * 111320 * 111320; // Aproxima√ß√£o: 1 grau ‚âà 111.32 km
    }

    function clearAllMeasurements() {
      // Limpar marcadores
      measurementPoints.forEach(marker => map.removeLayer(marker));
      measurementPoints = [];
      
      // Limpar linhas
      measurementLines.forEach(line => map.removeLayer(line));
      measurementLines = [];
      
      // Limpar pol√≠gonos
      measurementPolygons.forEach(polygon => map.removeLayer(polygon));
      measurementPolygons = [];
      
      // Limpar marcadores de coordenadas
      coordinateMarkers.forEach(marker => map.removeLayer(marker));
      coordinateMarkers = [];
      
      // Desativar ferramentas
      deactivateAllTools();
      
      console.log('Todas as medi√ß√µes foram limpas');
    }

    function toggleMeasurementPanel() {
      console.log('üìè Toggle painel medi√ß√£o...');
      var panel = document.getElementById('measurement-panel');
      var toggle = document.getElementById('measurement-toggle');
      
      if (panel.style.display === 'none' || panel.style.display === '') {
        panel.style.display = 'block';
        toggle.style.background = '#bbdefb';
        
        // Ocultar outros pain√©is
        document.getElementById('layers-panel').style.display = 'none';
        document.getElementById('basemap-panel').style.display = 'none';
        document.getElementById('layers-toggle').style.background = '#e3f2fd';
        document.getElementById('basemap-toggle').style.background = '#e3f2fd';
      } else {
        panel.style.display = 'none';
        toggle.style.background = '#e3f2fd';
        deactivateAllTools();
      }
    }
    
    // ===== FUN√á√ïES DE CONTROLE DE CAMADAS =====
    function toggleLayer(layerKey, isVisible) {
      // Converter a chave do arquivo para o nome mapeado
      const layerName = layerNames[layerKey] || layerKey;
      const layer = overlays[layerName];
      
      console.log('üîç Toggle Layer:', layerKey, '->', layerName, 'Visible:', isVisible, 'Layer found:', !!layer);
      
      if (layer) {
        if (isVisible) {
          layer.addTo(map);
        } else {
          map.removeLayer(layer);
        }
        reorderLayers();
        updateLegend();
      } else {
        console.error('‚ùå Camada n√£o encontrada:', layerKey, '->', layerName);
        console.log('üìã Overlays dispon√≠veis:', Object.keys(overlays));
      }
    }
    
    function setLayerOpacity(layerKey, opacity) {
      // Converter a chave do arquivo para o nome mapeado
      const layerName = layerNames[layerKey] || layerKey;
      const layer = overlays[layerName];
      
      console.log('üéöÔ∏è Set Opacity:', layerKey, '->', layerName, 'Opacity:', opacity, 'Layer found:', !!layer);
      
      if (layer) {
        layer.eachLayer(function(l) {
          if (l.setStyle) {
            if (l instanceof L.Polygon) {
              l.setStyle({fillOpacity: opacity, opacity: opacity});
            } else if (l instanceof L.Polyline) {
              l.setStyle({opacity: opacity});
            }
          }
        });
        
        // Atualizar o valor exibido
        const layerId = layerKey.replace('.geojson', '').toLowerCase();
        const valueElement = document.getElementById(`opacity-value-${layerId}`);
        if (valueElement) {
          valueElement.textContent = Math.round(opacity * 100) + '%';
        }
      } else {
        console.error('‚ùå Camada n√£o encontrada para opacidade:', layerKey, '->', layerName);
      }
    }
    
    // Fun√ß√£o para controlar labels dos bairros
    function toggleBairrosLabels(isVisible) {
      bairrosLabelsVisible = isVisible;
      
      if (camadaBairros) {
        camadaBairros.eachLayer(function(layer) {
          if (layer.bairroTooltip) {
            if (isVisible && map.hasLayer(camadaBairros)) {
              layer.openTooltip();
            } else {
              layer.closeTooltip();
            }
          }
        });
      }
      
      console.log(isVisible ? '‚úÖ Labels dos bairros ativados' : '‚ùå Labels dos bairros desativados');
    }
    
    // ===== INICIALIZA√á√ÉO DOS CHECKBOXES =====
    function initializeLayerCheckboxes() {
      console.log('üîß Inicializando checkboxes das camadas...');
      
      // Configura√ß√µes das camadas
      const layerConfigs = [
        { name: 'Litologia', layerKey: 'LITO_GARCA.geojson', color: '#8B4513', hasOpacity: true },
        { name: 'Aqu√≠fero', layerKey: 'AQUIF_GARCA.geojson', color: '#0066cc', hasOpacity: true },
        { name: 'Hidrografia', layerKey: 'HID_SP.geojson', color: '#0066cc', hasOpacity: false },
        { name: 'Limite Municipal', layerKey: 'MUN_GARCA.geojson', color: '#ffff00', hasOpacity: false },
        { name: 'Bairros', layerKey: 'Bairros_GARCA.geojson', color: '#8bc34a', hasOpacity: false },
        { name: 'Concha Ac√∫stica', layerKey: 'Concha_GARCA.geojson', color: '#ffb6c1', hasOpacity: true },
        { name: 'Lago Artificial', layerKey: 'LagoArtificial_GARCA.geojson', color: '#b2ebf2', hasOpacity: true },
        { name: 'Malha Rodovi√°ria', layerKey: 'MalhaRodoviaria.geojson', color: '#e31a1c', hasOpacity: false },
        { name: 'Vias Municipais', layerKey: 'ViasAcessos_GARCA.geojson', color: '#ff9800', hasOpacity: false }
      ];
      
      layerConfigs.forEach(config => {
        const layerId = config.layerKey.replace('.geojson', '').toLowerCase();
        const checkbox = document.getElementById(`layer-${layerId}`);
        const layerName = layerNames[config.layerKey] || config.layerKey;
        const layer = overlays[layerName];
        
        if (checkbox && layer) {
          // Marcar checkbox se a camada estiver vis√≠vel
          checkbox.checked = map.hasLayer(layer);
          console.log(`‚úÖ Checkbox ${config.name}: ${checkbox.checked ? 'marcado' : 'desmarcado'}`);
        }
      });
    }
    
    // ===== FUN√á√ïES ESPEC√çFICAS DE MEDI√á√ÉO =====
    
    // Medidor de Dist√¢ncia
    function activateDistanceTool() {
      deactivateAllTools();
      
      setTimeout(function() {
        document.getElementById('distance-btn').classList.add('active');
        map.getContainer().style.cursor = 'crosshair';
        
        var points = [];
        var line;
        var totalDistance = 0;
        var clickHandler;
        
        clickHandler = function(e) {
          L.DomEvent.stopPropagation(e);
          L.DomEvent.preventDefault(e);
          
          if (!e.latlng) {
            console.log('Clique sem coordenadas v√°lidas');
            return;
          }
          
          console.log('Clique registrado em:', e.latlng.lat, e.latlng.lng);
          
          points.push(e.latlng);
          
          var marker = createMeasurementMarker(e.latlng, points.length, 'distance').addTo(map);
          measurementPoints.push(marker);
          
          if (points.length > 1) {
            if (line) map.removeLayer(line);
            line = L.polyline(points, {
              color: '#ff4444', 
              weight: 3, 
              opacity: 0.8,
              dashArray: '5, 5'
            }).addTo(map);
            measurementLines.push(line);
            
            var distance = points[points.length - 2].distanceTo(points[points.length - 1]);
            totalDistance += distance;
            
            var popupContent = '<div style="min-width: 200px;">' +
              '<h4 style="margin: 0 0 8px 0; color: #ff4444;">üìè Medi√ß√£o de Dist√¢ncia</h4>' +
              '<p><strong>Dist√¢ncia Total:</strong> ' + formatDistance(totalDistance) + '</p>' +
              '<p><strong>Segmento:</strong> ' + formatDistance(distance) + '</p>' +
              '<p><strong>Pontos:</strong> ' + points.length + '</p>';
            
            if (measurementSettings.showCoordinates) {
              popupContent += '<p><strong>Coordenadas:</strong><br>' + formatCoordinates(e.latlng) + '</p>';
            }
            
            popupContent += '<p style="font-size: 11px; color: #666; margin-top: 8px;">Clique duplo para finalizar</p></div>';
            
            L.popup()
              .setLatLng(e.latlng)
              .setContent(popupContent)
              .openOn(map);
          }
        };
        
        var doubleClickHandler = function(e) {
          if (points.length >= 2) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            
            var result = saveMeasurementResult('distance', {
              totalDistance: totalDistance,
              points: points,
              coordinates: points.map(p => [p.lat, p.lng])
            });
            
            var finalPopupContent = '<div style="min-width: 220px;">' +
              '<h4 style="margin: 0 0 8px 0; color: #ff4444;">‚úÖ Medi√ß√£o Conclu√≠da</h4>' +
              '<p><strong>Dist√¢ncia Total:</strong> ' + formatDistance(totalDistance) + '</p>' +
              '<p><strong>Pontos:</strong> ' + points.length + '</p>' +
              '<p><strong>ID:</strong> ' + result.id + '</p>' +
              '<p style="font-size: 11px; color: #666; margin-top: 8px;">Medi√ß√£o salva no hist√≥rico</p></div>';
            
            L.popup()
              .setLatLng(points[points.length - 1])
              .setContent(finalPopupContent)
              .openOn(map);
            
            deactivateAllTools();
          }
        };
        
        map.on('click', clickHandler, { passive: false });
        map.on('dblclick', doubleClickHandler, { passive: false });
        
        currentMeasurementTool = {
          type: 'distance',
          clickHandler: clickHandler,
          doubleClickHandler: doubleClickHandler
        };
        
        console.log('Ferramenta de dist√¢ncia ativada');
      }, 100);
    }
    
    // Medidor de √Årea
    function activateAreaTool() {
      deactivateAllTools();
      
      setTimeout(function() {
        document.getElementById('area-btn').classList.add('active');
        map.getContainer().style.cursor = 'crosshair';
        
        // Desabilitar doubleClickZoom para evitar conflito
        if (map.doubleClickZoom && map.doubleClickZoom.disable) {
          map.doubleClickZoom.disable();
        }
        
        var points = [];
        var polygon;
        var clickHandler;
        var doubleClickHandler;
        
        clickHandler = function(e) {
          L.DomEvent.stopPropagation(e);
          L.DomEvent.preventDefault(e);
          
          if (!e.latlng) return;
          
          console.log('üîç Clique registrado para √°rea em:', e.latlng.lat, e.latlng.lng);
          
          points.push(e.latlng);
          
          var marker = createMeasurementMarker(e.latlng, points.length, 'area').addTo(map);
          measurementPoints.push(marker);
          
          if (points.length >= 3) {
            if (polygon) map.removeLayer(polygon);
            polygon = L.polygon(points, {
              color: '#44ff44',
              weight: 2,
              opacity: 0.8,
              fillColor: '#44ff44',
              fillOpacity: 0.3
            }).addTo(map);
            measurementPolygons.push(polygon);
            
            console.log('üìê Pol√≠gono criado com', points.length, 'pontos');
          }
        };
        
        doubleClickHandler = function(e) {
          console.log('üîç DoubleClickHandler chamado para √°rea');
          console.log('üîç Pontos:', points.length, 'Coordenadas:', e.latlng);
          
          if (points.length >= 3) {
            console.log('‚úÖ Condi√ß√£o de pontos >= 3 atendida');
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            
            var area = calculatePolygonArea(points);
            console.log('üìê √Årea calculada no duplo clique:', area);
            
            var result = saveMeasurementResult('area', {
              area: area,
              points: points,
              coordinates: points.map(p => [p.lat, p.lng])
            });
            console.log('üíæ Resultado salvo:', result);
            
            var finalPopupContent = '<div style="min-width: 220px;">' +
              '<h4 style="margin: 0 0 8px 0; color: #44ff44;">‚úÖ Medi√ß√£o Conclu√≠da</h4>' +
              '<p><strong>√Årea:</strong> ' + formatArea(area) + '</p>' +
              '<p><strong>Pontos:</strong> ' + points.length + '</p>' +
              '<p><strong>ID:</strong> ' + result.id + '</p>' +
              '<p style="font-size: 11px; color: #666; margin-top: 8px;">Medi√ß√£o salva no hist√≥rico</p></div>';
            
            console.log('üìã Conte√∫do do popup criado');
            
            // Usar setTimeout para garantir que o popup seja criado ap√≥s o evento
            setTimeout(function() {
              try {
                var popup = L.popup()
                  .setLatLng(points[points.length - 1])
                  .setContent(finalPopupContent)
                  .openOn(map);
                console.log('‚úÖ Popup aberto com sucesso');
              } catch (error) {
                console.error('‚ùå Erro ao abrir popup:', error);
              }
            }, 10);
            
            deactivateAllTools();
          } else {
            console.log('‚ùå Pontos insuficientes:', points.length);
          }
        };
        
        // Registrar event listeners
        map.on('click', clickHandler, { passive: false });
        map.on('dblclick', doubleClickHandler, { passive: false });
        
        console.log('üéØ Event listeners registrados: click e dblclick');
        
        currentMeasurementTool = {
          type: 'area',
          clickHandler: clickHandler,
          doubleClickHandler: doubleClickHandler
        };
        
        console.log('Ferramenta de √°rea ativada');
      }, 100);
    }
    
    // Coletor de Coordenadas
    function activateCoordinateTool() {
      deactivateAllTools();
      
      setTimeout(function() {
        document.getElementById('coordinate-btn').classList.add('active');
        map.getContainer().style.cursor = 'crosshair';
        
        var clickHandler = function(e) {
          L.DomEvent.stopPropagation(e);
          L.DomEvent.preventDefault(e);
          
          if (!e.latlng) return;
          
          var marker = createMeasurementMarker(e.latlng, coordinateMarkers.length + 1, 'coordinate').addTo(map);
          coordinateMarkers.push(marker);
          
          var result = saveMeasurementResult('coordinate', {
            coordinates: [e.latlng.lat, e.latlng.lng],
            point: e.latlng
          });
          
          var popupContent = '<div style="min-width: 200px;">' +
            '<h4 style="margin: 0 0 8px 0; color: #ffaa44;">üìç Coordenadas Coletadas</h4>' +
            '<p><strong>Latitude:</strong> ' + e.latlng.lat.toFixed(6) + '¬∞</p>' +
            '<p><strong>Longitude:</strong> ' + e.latlng.lng.toFixed(6) + '¬∞</p>' +
            '<p><strong>ID:</strong> ' + result.id + '</p>' +
            '<p style="font-size: 11px; color: #666; margin-top: 8px;">Clique em outro local para coletar mais coordenadas</p></div>';
          
          L.popup()
            .setLatLng(e.latlng)
            .setContent(popupContent)
            .openOn(map);
        };
        
        map.on('click', clickHandler, { passive: false });
        
        currentMeasurementTool = {
          type: 'coordinate',
          clickHandler: clickHandler
        };
        
        console.log('Ferramenta de coordenadas ativada');
      }, 100);
    }

    // ===== MINI MAPA =====
    function initMiniMap() {
      console.log('üó∫Ô∏è Iniciando mini-mapa...');
      
      // Verificar se o mapa principal est√° pronto
      if (!map) {
        console.error('‚ùå Mapa principal n√£o est√° pronto!');
        return;
      }
      
      // Obter refer√™ncias dos elementos
      miniMapContainer = document.getElementById('mini-map-container');
      miniMapToggle = document.getElementById('mini-map-toggle');
      
      if (!miniMapContainer || !miniMapToggle) {
        console.error('‚ùå Elementos do mini-mapa n√£o encontrados!');
        return;
      }
      
      // Criar mini-mapa com OpenStreetMap como basemap
      miniMap = L.map('mini-map', {
        zoomControl: false,
        attributionControl: false,
        dragging: true,
        touchZoom: true,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        tap: false
      });
      
      console.log('‚úÖ Mini-mapa criado:', miniMap);
      
      // Adicionar basemap OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
      }).addTo(miniMap);
      
      console.log('‚úÖ Basemap adicionado ao mini-mapa');
      
      // Definir view inicial (regi√£o de Gar√ßa-SP)
      miniMap.setView([-22.2125, -49.6564], 10);
      
      console.log('‚úÖ View inicial definida');
      
      // Verificar se o mapa principal tem bounds v√°lidos
      if (!map.getBounds().isValid()) {
        console.warn('‚ö†Ô∏è Mapa principal ainda n√£o tem bounds v√°lidos, aguardando...');
        setTimeout(() => {
          if (map.getBounds().isValid()) {
            console.log('‚úÖ Mapa principal agora tem bounds v√°lidos');
            updateMiniMapOverlay();
          }
        }, 1000);
        return;
      }
      
      // Chamar fun√ß√£o para adicionar overlay
      updateMiniMapOverlay();
      
      console.log('‚úÖ Mini-mapa inicializado com sucesso');
    }
    
    function updateMiniMapOverlay() {
      if (!miniMap || !map) return;
      
      // Adicionar ret√¢ngulo que mostra a √°rea vis√≠vel no mapa principal
      var bounds = map.getBounds();
      var overviewRect = L.rectangle(bounds, {
        color: '#ff0000',
        weight: 2,
        fillColor: '#ff0000',
        fillOpacity: 0.1
      }).addTo(miniMap);
      
      // Adicionar marcador central para mostrar o centro do mapa principal
      var centerMarker = L.circleMarker(map.getCenter(), {
        radius: 4,
        color: '#ff0000',
        fillColor: '#ff0000',
        fillOpacity: 0.8,
        weight: 1
      }).addTo(miniMap);
      
      console.log('‚úÖ Ret√¢ngulo e marcador adicionados');
      
      // Atualizar ret√¢ngulo e marcador quando o mapa principal mudar
      map.on('moveend', function() {
        var newBounds = map.getBounds();
        var newCenter = map.getCenter();
        overviewRect.setBounds(newBounds);
        centerMarker.setLatLng(newCenter);
      });
      
      // Atualizar tamb√©m durante o movimento (mais fluido)
      map.on('move', function() {
        var newBounds = map.getBounds();
        var newCenter = map.getCenter();
        overviewRect.setBounds(newBounds);
        centerMarker.setLatLng(newCenter);
      });
      
      // Permitir navega√ß√£o no mini-mapa com arrastar
      miniMap.on('mousedown', function(e) {
        var clickedLatLng = e.latlng;
        map.setView(clickedLatLng, map.getZoom());
      });
      
      // Permitir zoom no mini-mapa
      miniMap.on('wheel', function(e) {
        e.originalEvent.preventDefault();
        var zoom = map.getZoom();
        if (e.originalEvent.deltaY < 0) {
          map.setZoom(zoom + 1);
        } else {
          map.setZoom(zoom - 1);
        }
      });
      
      // Sincronizar zoom entre os mapas
      map.on('zoomend', function() {
        var currentZoom = map.getZoom();
        var miniMapZoom = miniMap.getZoom();
        
        // Ajustar zoom do mini-mapa para manter contexto
        if (currentZoom > 12) {
          miniMap.setZoom(10);
        } else if (currentZoom > 8) {
          miniMap.setZoom(8);
        } else {
          miniMap.setZoom(6);
        }
      });
    }
    
    function toggleMiniMap() {
      if (!miniMapVisible) {
        // Mostrar mini-mapa
        miniMapContainer.style.display = 'block';
        miniMapToggle.textContent = 'üó∫Ô∏è Ocultar';
        miniMapToggle.title = 'Ocultar Mini Mapa';
        miniMapVisible = true;
        
        // Inicializar mini-mapa se ainda n√£o foi criado
        if (!miniMap) {
          setTimeout(initMiniMap, 100);
        } else {
          miniMap.invalidateSize();
        }
      } else {
        // Ocultar mini-mapa
        miniMapContainer.style.display = 'none';
        miniMapToggle.textContent = 'üó∫Ô∏è Mostrar';
        miniMapToggle.title = 'Mostrar Mini Mapa';
        miniMapVisible = false;
      }
    }

    // ===== CONTROLES DE ZOOM SOFISTICADOS =====
    function createSophisticatedZoomControls() {
      console.log('üîç Criando controles de zoom sofisticados...');
      
      const zoomInBtn = document.getElementById('zoom-in-btn');
      const zoomOutBtn = document.getElementById('zoom-out-btn');
      const zoomResetBtn = document.getElementById('zoom-reset-btn');
      const zoomLevelDisplay = document.getElementById('zoom-level-display');
      
      // Fun√ß√£o para atualizar display do n√≠vel de zoom
      function updateZoomDisplay() {
        const currentZoom = map.getZoom();
        const previousZoom = parseInt(zoomLevelDisplay.textContent) || currentZoom;
        
        zoomLevelDisplay.textContent = currentZoom;
        
        // Atualizar estado dos bot√µes
        zoomInBtn.disabled = currentZoom >= map.getMaxZoom();
        zoomOutBtn.disabled = currentZoom <= map.getMinZoom();
        
        // Adicionar efeito visual ao display se o zoom mudou
        if (currentZoom !== previousZoom) {
          zoomLevelDisplay.classList.add('zoom-changed');
          setTimeout(() => {
            zoomLevelDisplay.classList.remove('zoom-changed');
          }, 600);
        }
        
        // Efeito de brilho no display
        zoomLevelDisplay.style.transform = 'scale(1.05)';
        setTimeout(() => {
          zoomLevelDisplay.style.transform = 'scale(1)';
        }, 200);
      }
      
      // Event listeners para os bot√µes
      zoomInBtn.addEventListener('click', function() {
        console.log('üîç Zoom In clicado');
        map.zoomIn();
        updateZoomDisplay();
        
        // Efeito visual aprimorado
        this.style.transform = 'scale(0.92) translateY(1px)';
        setTimeout(() => {
          this.style.transform = 'scale(1) translateY(0)';
        }, 200);
      });
      
      zoomOutBtn.addEventListener('click', function() {
        console.log('üîç Zoom Out clicado');
        map.zoomOut();
        updateZoomDisplay();
        
        // Efeito visual aprimorado
        this.style.transform = 'scale(0.92) translateY(1px)';
        setTimeout(() => {
          this.style.transform = 'scale(1) translateY(0)';
        }, 200);
      });
      
      zoomResetBtn.addEventListener('click', function() {
        console.log('üîç Reset Zoom clicado');
        map.setView([-22.2125, -49.6547], 11); // Centro de Gar√ßa-SP
        updateZoomDisplay();
        
        // Efeito visual aprimorado
        this.style.transform = 'scale(0.92) translateY(1px)';
        setTimeout(() => {
          this.style.transform = 'scale(1) translateY(0)';
        }, 200);
      });
      
      // Atualizar display quando o zoom mudar
      map.on('zoomend', updateZoomDisplay);
      
      // Atualizar display inicial
      updateZoomDisplay();
      
      // Adicionar suporte para atalhos de teclado
      document.addEventListener('keydown', function(e) {
        // Ctrl + + para zoom in
        if (e.ctrlKey && e.key === '=') {
          e.preventDefault();
          zoomInBtn.click();
        }
        // Ctrl + - para zoom out
        if (e.ctrlKey && e.key === '-') {
          e.preventDefault();
          zoomOutBtn.click();
        }
        // Ctrl + 0 para reset
        if (e.ctrlKey && e.key === '0') {
          e.preventDefault();
          zoomResetBtn.click();
        }
      });
      
      console.log('‚úÖ Controles de zoom sofisticados criados');
    }

                        // ===== FUN√á√ïES GO TO =====
                    function goToConchaAcustica() {
                      console.log('üéµ Navegando para Concha Ac√∫stica...');
                      
                      // Garantir que a camada da Concha Ac√∫stica esteja vis√≠vel
                      if (overlays['Concha Ac√∫stica']) {
                        if (!map.hasLayer(overlays['Concha Ac√∫stica'])) {
                          map.addLayer(overlays['Concha Ac√∫stica']);
                        }
                        
                        // Atualizar checkbox se existir
                        const checkbox = document.querySelector('input[data-layer="Concha_GARCA.geojson"]');
                        if (checkbox) {
                          checkbox.checked = true;
                        }
                        
                        // Fazer zoom para a extens√£o real da camada (poligonal)
                        const layer = overlays['Concha Ac√∫stica'];
                        if (layer && layer.getBounds) {
                          const bounds = layer.getBounds();
                          map.flyToBounds(bounds, {
                            duration: 2.0,
                            easeLinearity: 0.25,
                            padding: [20, 20] // Padding para n√£o ficar colado nas bordas
                          });
                          
                          // Mostrar popup informativo no centro do bounds
                          setTimeout(() => {
                            const center = bounds.getCenter();
                            L.popup()
                              .setLatLng(center)
                              .setContent(`
                                <div style="text-align: center; padding: 10px;">
                                  <h4 style="margin: 0 0 8px 0; color: #7c3aed;">üéµ Concha Ac√∫stica</h4>
                                  <p style="margin: 0; font-size: 12px; color: #666;">
                                    Visualizando a extens√£o completa da Concha Ac√∫stica
                                  </p>
                                </div>
                              `)
                              .openOn(map);
                          }, 2500);
                        }
                      } else {
                        console.warn('Camada Concha Ac√∫stica n√£o encontrada');
                      }
                    }

                        function goToLagoArtificial() {
                      console.log('üíß Navegando para Lago Artificial...');
                      
                      // Garantir que a camada do Lago Artificial esteja vis√≠vel
                      if (overlays['Lago Artificial']) {
                        if (!map.hasLayer(overlays['Lago Artificial'])) {
                          map.addLayer(overlays['Lago Artificial']);
                        }
                        
                        // Atualizar checkbox se existir
                        const checkbox = document.querySelector('input[data-layer="LagoArtificial_GARCA.geojson"]');
                        if (checkbox) {
                          checkbox.checked = true;
                        }
                        
                        // Fazer zoom para a extens√£o real da camada (poligonal)
                        const layer = overlays['Lago Artificial'];
                        if (layer && layer.getBounds) {
                          const bounds = layer.getBounds();
                          map.flyToBounds(bounds, {
                            duration: 2.0,
                            easeLinearity: 0.25,
                            padding: [20, 20] // Padding para n√£o ficar colado nas bordas
                          });
                          
                          // Mostrar popup informativo no centro do bounds
                          setTimeout(() => {
                            const center = bounds.getCenter();
                            L.popup()
                              .setLatLng(center)
                              .setContent(`
                                <div style="text-align: center; padding: 10px;">
                                  <h4 style="margin: 0 0 8px 0; color: #2563eb;">üíß Lago Artificial</h4>
                                  <p style="margin: 0; font-size: 12px; color: #666;">
                                    Visualizando a extens√£o completa do Lago Artificial
                                  </p>
                                </div>
                              `)
                              .openOn(map);
                          }, 2500);
                        }
                      } else {
                        console.warn('Camada Lago Artificial n√£o encontrada');
                      }
                    }

    // ===== INICIALIZA√á√ÉO =====
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Inicializando WebGIS...');
      
      // Inicializar mapa
      initializeMap();
      
      // Inicializar basemaps
      initializeBasemaps();
      
      // Criar legenda
      createLegend();
      
      // Criar pain√©is de controle
      createControlPanels();
      
      // Carregar camadas com delay
      console.log('üîÑ Iniciando carregamento das camadas...');
      setTimeout(() => {
        console.log('üîÑ Carregando camada Litologia...');
        addGeoJsonLayer('LITO_GARCA.geojson', 'LITO_GARCA.geojson', litologiaStyle);
      }, 500);
      setTimeout(() => {
        console.log('üîÑ Carregando camada Aqu√≠fero...');
        addGeoJsonLayer('AQUIF_GARCA.geojson', 'AQUIF_GARCA.geojson', aquiferoStyle);
      }, 1000);
      setTimeout(() => addGeoJsonLayer('HID_SP.geojson', 'HID_SP.geojson', layerStyles['HID_SP.geojson']), 1500);
      setTimeout(() => addGeoJsonLayer('Concha_GARCA.geojson', 'Concha_GARCA.geojson', layerStyles['Concha_GARCA.geojson']), 2000);
      setTimeout(() => addGeoJsonLayer('LagoArtificial_GARCA.geojson', 'LagoArtificial_GARCA.geojson', layerStyles['LagoArtificial_GARCA.geojson']), 2500);
      setTimeout(() => addGeoJsonLayer('MUN_GARCA.geojson', 'MUN_GARCA.geojson', layerStyles['MUN_GARCA.geojson']), 3000);
      setTimeout(() => addGeoJsonLayer('Bairros_GARCA.geojson', 'Bairros_GARCA.geojson', bairrosStyle), 3500);
      setTimeout(() => addGeoJsonLayer('MalhaRodoviaria.geojson', 'MalhaRodoviaria.geojson', layerStyles['MalhaRodoviaria.geojson']), 4000);
      setTimeout(() => addGeoJsonLayer('ViasAcessos_GARCA.geojson', 'ViasAcessos_GARCA.geojson', layerStyles['ViasAcessos_GARCA.geojson']), 4500);
      
      // Configurar coordenadas
      map.on('mousemove', updateCoordinates);
      
      // Inicializar event listeners das ferramentas de medi√ß√£o
      document.getElementById('distance-btn').addEventListener('click', activateDistanceTool);
      document.getElementById('area-btn').addEventListener('click', activateAreaTool);
      document.getElementById('coordinate-btn').addEventListener('click', activateCoordinateTool);
      document.getElementById('clear-measurements-btn').addEventListener('click', clearAllMeasurements);
      
      // Inicializar mini-mapa (ser√° inicializado ap√≥s carregamento das camadas)
      document.getElementById('mini-map-toggle').addEventListener('click', toggleMiniMap);
      
      // Inicializar bot√µes Go to
      document.getElementById('goto-concha').addEventListener('click', goToConchaAcustica);
      document.getElementById('goto-lago').addEventListener('click', goToLagoArtificial);
      
      // Reordenar camadas e atualizar legenda ap√≥s carregamento
      setTimeout(() => {
        console.log('üîÑ Verificando estado das camadas...');
        console.log('üìã Camada Litologia:', camadaLitologia);
        console.log('üìã Camada Aqu√≠fero:', camadaAquifero);
        console.log('üìã Mapa tem camada Litologia:', map.hasLayer(camadaLitologia));
        console.log('üìã Mapa tem camada Aqu√≠fero:', map.hasLayer(camadaAquifero));
        console.log('üìã Overlays dispon√≠veis:', Object.keys(overlays));
        
        reorderLayers();
        updateLegend();
        initializeLayerCheckboxes();
        
        // Verificar se o mini mapa ainda n√£o foi inicializado
        if (!miniMap) {
          console.log('üîÑ Inicializando mini mapa ap√≥s carregamento das camadas...');
          initMiniMap();
          document.getElementById('mini-map-toggle').addEventListener('click', toggleMiniMap);
        }
        
        // For√ßar atualiza√ß√£o da legenda ap√≥s um delay adicional
        setTimeout(() => {
          console.log('üîÑ For√ßando atualiza√ß√£o da legenda...');
          updateLegend();
        }, 1000);
      }, 5000);
      
      // Atualizar legenda quando camadas mudarem
      map.on('overlayadd overlayremove', updateLegend);
      
      console.log('‚úÖ WebGIS inicializado com sucesso!');
    });
  </script>
</body>
</html> 